<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SB Tester (con diagn√≥stico)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
<style>
  body{font:600 14px system-ui,Segoe UI,Roboto;margin:0;background:#f8fafc;color:#0f172a}
  .wrap{max-width:900px;margin:16px auto;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  button{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
  #out,#rt{background:#0b1220;color:#d1e9ff;padding:12px;border-radius:10px;min-height:140px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <h2>Prueba Supabase ‚Äî Conexi√≥n y Realtime</h2>
  <div class="row">
    <button id="ping">Ping</button>
    <button id="ins">Insertar TEST (hoy)</button>
    <button id="get">Leer 5</button>
  </div>

  <h3>Salida</h3>
  <div id="out">Cargando‚Ä¶</div>

  <h3>Realtime</h3>
  <div id="rt">Esperando eventos‚Ä¶</div>
</div>

<script>
(function(){
  const OUT = document.getElementById('out');
  const RT  = document.getElementById('rt');
  const log = (m, ok=true) => {
    const ts = new Date().toLocaleTimeString();
    OUT.textContent = `[${ts}] ${ok?'‚úÖ':'‚ùå'} ` + (typeof m==='string'?m:JSON.stringify(m,null,2)) + "\n" + OUT.textContent;
  };
  const rt  = (m) => {
    const ts = new Date().toLocaleTimeString();
    RT.textContent = `[${ts}] üîî ` + (typeof m==='string'?m:JSON.stringify(m,null,2)) + "\n" + RT.textContent;
  };

  // Reportar cualquier error JS en pantalla
  window.onerror = (msg, src, line, col, err) => {
    log({error: String(msg), src, line, col, detail: (err && err.stack)||String(err)}, false);
  };

  // Espera a que cargue la librer√≠a (defer asegura orden, pero por si acaso)
  function ready(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  ready(async () => {
    if (!window.supabase) { log('No carg√≥ @supabase/supabase-js (revisa conexi√≥n o CDN)', false); return; }

    const URL = "https://mzjthivwubvvjjsvbhtb.supabase.co";
    const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16anRoaXZ3dWJ2dmpqc3ZiaHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjA3MzAsImV4cCI6MjA3MjUzNjczMH0.1wNvnBjhnOLLtpD-JmH1Hytrbo4P6HI6rA5Yv7mWaEs";

    let sb = null;
    try { sb = window.supabase.createClient(URL, KEY); }
    catch(e){ log(e, false); return; }

    // Funciones
    async function ping(){
      try{
        const { error } = await sb.from('events').select('id',{ head:true, count:'exact' });
        if (error) log(error, false); else log({estado:'online', url: URL});
      }catch(e){ log(e, false); }
    }

    function todayNoonISO(){ const d=new Date(); d.setHours(12,0,0,0); return d.toISOString(); }

    async function insertTest(){
      try{
        const payload = { dt: todayNoonISO(), rooms:['1211'], title:'TEST', tag:'cumplea√±os' };
        const { data, error } = await sb.from('events').insert(payload).select().single();
        if (error) log(error, false); else log({insertado:data});
      }catch(e){ log(e, false); }
    }

    async function read5(){
      try{
        const { data, error } = await sb.from('events')
          .select('id, dt, rooms, title, tag, created_at')
          .order('created_at',{ascending:false}).limit(5);
        if (error) log(error, false); else log(data);
      }catch(e){ log(e, false); }
    }

    // Botones
    document.getElementById('ping').onclick = ping;
    document.getElementById('ins').onclick  = insertTest;
    document.getElementById('get').onclick  = read5;

    // Realtime
    try{
      const ch = sb.channel('events_rt')
        .on('postgres_changes',{ event:'*', schema:'public', table:'events' }, (payload)=> rt(payload))
        .subscribe((status)=> rt('estado canal: '+status));
    }catch(e){ rt(e); }

    // Auto-ping al cargar
    ping();
  });
})();
</script>
</body>
</html>
