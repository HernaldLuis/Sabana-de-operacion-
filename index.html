<!doctype html>
<html lang="es-MX">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>S√°bana de Operaci√≥n</title>

  <style>
    [hidden]{ display:none !important; }

    :root{
      --cell-inline: 8px;
      --num-min:    46px;
      --salida-bg:  #fef3c7;
      --salida-bd:  #f59e0b;
    
      --llegada-bg: #dbeafe;
      --llegada-bd: #2563eb;
    
      --ocupada-bg: #fce7f3;
      --ocupada-bd: #ec4899;
    
      --fuera-bg: #FFEDD5; --fuera-bd: #F97316;
    
      --show-bg: #ECFCCB;
      --show-bd: #84CC16;
    }

    /* ======= Tabla estilo Excel ======= */
    .table-scroller table.excel{
      border-collapse: collapse !important;
      font-family: Arial, Helvetica, sans-serif !important;
      font-size: 12px !important;
      width: max-content !important;
      background:#fff;
    }
    .table-scroller table.excel td{
      border: 1px solid #cfd4dd !important;
      padding-block: 4px !important;
      padding-inline: var(--cell-inline) !important;
      text-align: center !important;
      white-space: nowrap !important;
    }
    .table-scroller table.excel td:nth-child(3n+1){
      padding-inline: calc(var(--cell-inline) - 1px) !important;
      min-width: var(--num-min) !important;
      font-variant-numeric: tabular-nums;
      font-weight:600; color:#111827;
    }
    td.tipo.k{ color:#2563eb; font-weight:700; }
    td.tipo.d{ color:#059669; font-weight:700; }

    /* Estado visual Salidas (amarillo) */
    td.estado-salida{
      background: var(--salida-bg) !important;
      box-shadow: inset 0 0 0 1px var(--salida-bd);
    }

/* Badge üõ´ for Salidas */
td.estado-salida{
  background: var(--salida-bg) !important;
  box-shadow: inset 0 0 0 1px var(--salida-bd);
  position: relative;
}
td.estado-salida::after{
  content: "üõ´";
  position: absolute;
  top: 2px;
  right: 4px;
  font-size: 12px;
  line-height: 1;
  pointer-events: none;
}


    /* ======= Layout general ======= */
    .page-wrap{ width:fit-content; margin:0 auto; padding:0 8px; }
    @supports not (width:fit-content){
      body{ text-align:center; }
      .page-wrap{ display:inline-block; text-align:left; }
    }

    /* ======= Header sticky ======= */
    .header-sabana{
      position: sticky; top: 0; z-index: 20;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      display:flex; align-items:center; gap:10px;
      padding: 6px 0; margin: 0 0 8px;
      flex-wrap: wrap;
    }
    .header-sabana .logo{ height: clamp(40px, 6vw, 72px); width:auto; display:block; }
    .header-text{ display:flex; flex-direction:column; gap:2px; }
    .page-title{
      font-family: Georgia, "Times New Roman", Times, serif;
      font-style: italic; font-weight: 700;
      font-size: clamp(22px, 2.4vw, 30px);
      line-height: 1.05; letter-spacing: -0.01em;
      color:#111827; margin:0; text-align:left;
    }
    .meta-line{
      display:flex; align-items:center; gap:6px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 15px; color:#1f2937;
    }
    .meta-line .icon{ font-size:15px; opacity:.8; }
    .time{ color:#dc2626; font-weight:700; letter-spacing:.04em; }

    /* ======= Botones de acciones (derecha) ======= */
    .header-actions{ margin-left: auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tool-btn{
      appearance:none; border:1px solid #d1d5db; background:#fff; color:#111827;
      border-radius:9999px; padding:8px 12px;
      font:600 13px/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      cursor:pointer; transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
      white-space:nowrap;
    }
    .tool-btn:hover{ box-shadow:0 1px 0 rgba(0,0,0,.04); }
    .tool-btn.active{ box-shadow:0 0 0 2px rgba(17,24,39,.08) inset; }
    .btn-salidas  { background:#fef3c7; border-color:#f59e0b; color:#92400e; }
    .btn-llegadas { background:#dbeafe; border-color:#2563eb; color:#1e3a8a; }
    .btn-ocupadas { background:#fce7f3; border-color:#ec4899; color:#9d174d; }
    .btn-fuera    { background:#fee2e2; border-color:#dc2626; color:#991b1b; }
    .btn-showroom { background:#ecfccb; border-color:#84cc16; color:#365314; }
    .tool-btn .count{ font-weight:800; margin-left:6px; }

    /* ======= Barra de m√©tricas ======= */
    .metrics-bar{
      flex-basis: 100%;
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      margin-top:6px;
    }
    .stat-pill{
      appearance:none; border:1px solid #d1d5db; border-radius:9999px;
      background:#fff; color:#111827;
      padding:8px 12px; display:flex; align-items:center; gap:8px;
      font:600 13px/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      white-space:nowrap; cursor:default;
    }
    .stat-pill .label{ opacity:.85; }
    .stat-pill .value{ font-weight:800; letter-spacing:.02em; }

    .stat-ocupacion { background:#fff7ed; border-color:#f59e0b; color:#7c2d12; }
    .stat-nps       { background:#e0e7ff; border-color:#6366f1; color:#3730a3; }
    .stat-queue     { background:#cffafe; border-color:#06b6d4; color:#164e63; }
    .stat-ip        { background:#bbf7d0; border-color:#16a34a; color:#065f46; }

    .stat-expedia   { background:#fef9c3; border-color:#eab308; color:#713f12; }
    .stat-booking   { background:#e0f2fe; border-color:#0284c7; color:#0c4a6e; }
    .stat-vips      { background:#f3e8ff; border-color:#7c3aed; color:#4c1d95; }

    .is-low  { background:#d1fae5 !important; border-color:#10b981 !important; color:#065f46 !important; }
    .is-mid  { background:#fef3c7 !important; border-color:#f59e0b !important; color:#7c2d12 !important; }
    .is-high { background:#fee2e2 !important; border-color:#ef4444 !important; color:#991b1b !important; }

    .table-scroller{ overflow-x:auto; -webkit-overflow-scrolling:touch; background:#fafafa; padding-bottom:4px; }

    @media (max-width: 600px){
      .header-sabana .logo{ height: 36px; }
      .page-title{ font-size: 19px; }
      .meta-line{ font-size: 13px; }
      .table-scroller table.excel{ font-size: 11px !important; }
      .tool-btn{ padding:6px 10px; font-size:12px; }
      .stat-pill{ padding:6px 10px; font-size:12px; }
      :root{ --cell-inline: 7px; --num-min: 44px; }
    }

    /* ===== Modal gen√©rico ===== */
    .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:1000; padding:16px; }
    .modal-box{ background:#fff; border-radius:12px; max-width:560px; width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
    .modal-box header{padding:12px 16px; border-bottom:1px solid #e5e7eb; font-weight:700}
    .modal-box .content{padding:16px; line-height:1.5}
    .modal-box footer{padding:12px 16px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap}
    .btn{border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer}
    .btn.primary{background:#111827; color:#fff; border-color:#111827}

    /* ===== Chips para lista actual ===== */
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:9999px; border:1px solid #d1d5db; background:#fff;
      font:600 12px/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .chip .x{ cursor:pointer; font-weight:800; padding:2px 4px; border-radius:6px; }
    .chip .x:hover{ background:#f3f4f6; }
    .hint{ font-size:12px; color:#6b7280; margin-top:6px; }
    .input-lista{ width:100%; min-height:96px; resize:vertical; padding:8px; border:1px solid #d1d5db; border-radius:8px; font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
  
    /* === Mejora modal Salidas: panel scroll y grid === */
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 720px){ .grid-2{ grid-template-columns: 1fr; } }
    .chips-panel{ display:flex; flex-direction:column; gap:8px; }
    .chips-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .chips-scroll{ border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:8px;
      max-height:260px; overflow:auto; }
    .chips-tools{ display:flex; align-items:center; gap:8px; }
    .search{ padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; min-width:0; }
    .chip{ display:inline-flex; align-items:center; gap:6px; }
    .chip .x{ font-weight:900; cursor:pointer; opacity:.6; }
    .chip .x:hover{ opacity:1; }

  
/* ======= CHULEADO: Modal de Salidas (amarillo) ======= */
.modal-box.modal-salidas{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.salidas-header{
  display:flex; align-items:center; gap:10px;
  background:#FEF3C7; color:#92400E; border-bottom:1px solid #F59E0B;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.salidas-icon{ font-size:18px; line-height:1; }
.salidas-badge{
  margin-left:auto; background:#F59E0B; color:#fff; font-weight:900;
  padding:2px 8px; border-radius:9999px; font-size:12px;
}
.modal-backdrop{ animation: fadeIn .18s ease-out; }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
@keyframes slideUp{ from{ transform: translateY(8px); } to{ transform: translateY(0); } }

/* Botones tem√°ticos */
.modal-salidas .btn.primary{ background:#F59E0B; border-color:#F59E0B; color:#fff; }
.modal-salidas .btn.primary:hover{ filter:brightness(0.95); }
.modal-salidas .btn.warn{ border-color:#ef4444; color:#991b1b; }
.modal-salidas .btn.warn:hover{ background:#fee2e2; }

/* Chips v√°lidos / inv√°lidos */
.chip.valid{ background:#FEF9C3; border-color:#F59E0B; }
.chip.invalid{ background:#F3F4F6; border-color:#ef4444; color:#7f1d1d; }
.chip.invalid::after{ content:" ‚ùå"; font-weight:900; }

  
/* Estado visual Llegadas (azul) + badge üõ¨ */
td.estado-llegada{
  background: var(--llegada-bg) !important;
  box-shadow: inset 0 0 0 1px var(--llegada-bd);
  position: relative;
}
td.estado-llegada::after{
  content: "üõ¨";
  position: absolute;
  top: 2px;
  right: 4px;
  font-size: 12px;
  line-height: 1;
  pointer-events: none;
}

  
/* ======= CHULEADO: Modal de Llegadas (azul) ======= */
.modal-box.modal-llegadas{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.llegadas-header{
  display:flex; align-items:center; gap:10px;
  background:#DBEAFE; color:#1E3A8A; border-bottom:1px solid #2563EB;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.llegadas-icon{ font-size:18px; line-height:1; }
.llegadas-badge{
  margin-left:auto; background:#2563EB; color:#fff; font-weight:900;
  padding:2px 8px; border-radius:9999px; font-size:12px;
}
/* Chips v√°lidos / inv√°lidos para llegadas */
.chip.arr-valid{ background:#E0F2FE; border-color:#2563EB; }
.chip.arr-invalid{ background:#F3F4F6; border-color:#ef4444; color:#7f1d1d; }
.chip.arr-invalid::after{ content:" ‚ùå"; font-weight:900; }

  
/* Estado visual Ocupadas (rosa) + badge üõå */
td.estado-ocupada{
  background: var(--ocupada-bg) !important;
  box-shadow: inset 0 0 0 1px var(--ocupada-bd);
  position: relative;
}
td.estado-ocupada::after{
  content: "üõå";
  position: absolute;
  top: 2px;
  right: 4px;
  font-size: 12px;
  line-height: 1;
  pointer-events: none;
}

  
/* ======= CHULEADO: Modal de Ocupadas (rosa) ======= */
.modal-box.modal-ocupadas{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.ocupadas-header{
  display:flex; align-items:center; gap:10px;
  background:#FCE7F3; color:#9D174D; border-bottom:1px solid #EC4899;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.ocupadas-icon{ font-size:18px; line-height:1; }
.ocupadas-badge{
  margin-left:auto; background:#EC4899; color:#fff; font-weight:900;
  padding:2px 8px; border-radius:9999px; font-size:12px;
}
/* Chips v√°lidos / inv√°lidos para ocupadas */
.chip.occ-valid{ background:#FCE7F3; border-color:#EC4899; }
.chip.occ-invalid{ background:#F3F4F6; border-color:#ef4444; color:#7f1d1d; }
.chip.occ-invalid::after{ content:" ‚ùå"; font-weight:900; }

  
/* Estado visual Fuera de Servicio (rojo/naranja) + badge üöß */
td.estado-fuera{
  background: var(--fuera-bg) !important;
  box-shadow: inset 0 0 0 1px var(--fuera-bd);
  position: relative;
}
td.estado-fuera::after{
  content: "";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  background-image: url('https://res.cloudinary.com/dor6za85u/image/upload/v1756957081/Alert_kc90qp.gif');
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  pointer-events: none;
}

  
/* ======= CHULEADO: Modal de Fuera de Servicio (naranja/rojo) ======= */
.modal-box.modal-fuera{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.fuera-header{
  display:flex; align-items:center; gap:10px;
  background:#FFEDD5; color:#9A3412; border-bottom:1px solid #F97316;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.fuera-icon{
  width:18px; height:18px; display:inline-block;
  background-image:url('https://res.cloudinary.com/dor6za85u/image/upload/v1756957081/Alert_kc90qp.gif');
  background-size:contain; background-position:center; background-repeat:no-repeat;
}
.fuera-badge{
  margin-left:auto; background:#EA580C; color:#fff; font-weight:900;
  padding:2px 8px; border-radius:9999px; font-size:12px;
}
/* Chips v√°lidos / inv√°lidos para fuera de servicio */
.chip.out-valid{ background:#FFEDD5; border-color:#F97316; }
.chip.out-invalid{ background:#F3F4F6; border-color:#ef4444; color:#7f1d1d; }
.chip.out-invalid::after{ content:" ‚ùå"; font-weight:900; }

  
/* Estado visual Show Room (verde) + badge üìç */
td.estado-showroom{
  background: var(--show-bg) !important;
  box-shadow: inset 0 0 0 1px var(--show-bd);
  position: relative;
}
td.estado-showroom::after{
  content: "üìç";
  position: absolute;
  top: 2px;
  right: 4px;
  font-size: 12px;
  line-height: 1;
  pointer-events: none;
}

  
/* ======= CHULEADO: Modal de Show Room (verde) ======= */
.modal-box.modal-showroom{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.showroom-header{
  display:flex; align-items:center; gap:10px;
  background:#ECFCCB; color:#365314; border-bottom:1px solid #84CC16;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.showroom-icon{ font-size:18px; line-height:1; }
.showroom-badge{
  margin-left:auto; background:#65A30D; color:#fff; font-weight:900;
  padding:2px 8px; border-radius:9999px; font-size:12px;
}
/* Chips v√°lidos / inv√°lidos para showroom */
.chip.show-valid{ background:#ECFCCB; border-color:#84CC16; }
.chip.show-invalid{ background:#F3F4F6; border-color:#ef4444; color:#7f1d1d; }
.chip.show-invalid::after{ content:" ‚ùå"; font-weight:900; }

  
/* === Ensanchar visualmente el √°rea de tabla a casi pantalla completa (sin tocar alturas) === */
.page-wrap{ width: 100% !important; }
.table-scroller{ width: 100% !important; }

  
/* === Centrar la tabla cuando sobre espacio horizontal (sin tocar alturas) === */
.page-wrap{ width: 100% !important; }
.table-scroller{
  width: 100% !important;
  display: flex;                 /* permite centrar el contenido si hay espacio */
  justify-content: center;
}
.table-scroller > table.excel{ margin: 0 auto; }

  
/* === Mejora m√≥vil: sin tocar funcionalidad === */
@media (max-width: 600px){
  .modal-box{ max-width:100vw; }
  .list-input, .search, .btn{ font-size:16px; }   /* evita zoom en iOS */
  .chips-scroll{ max-height: 45vh; }              /* mejor uso del alto */
  .chip .x{ padding:6px; }                        /* tap target m√°s grande */
  .tool-btn{ min-height:40px; }                   /* botones c√≥modos al tacto */
}

  
/* ===== NPS Modal & Chart ===== */
.modal-box.modal-nps{ border-radius:16px; overflow:hidden; animation: slideUp .18s ease-out; }
.nps-header{
  display:flex; align-items:center; gap:10px;
  background:#E0F2FE; color:#075985; border-bottom:1px solid #0EA5E9;
  padding:12px 16px; font-weight:800; letter-spacing:.2px;
}
.nps-icon{ font-size:18px; line-height:1; }
.nps-badge{ margin-left:auto; background:#0EA5E9; color:#fff; font-weight:900; padding:2px 8px; border-radius:9999px; font-size:12px; }
.nps-grid{ display:grid; grid-template-columns: 320px 1fr; gap:16px; }
@media (max-width: 900px){ .nps-grid{ grid-template-columns:1fr; } }
.nps-form .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
.nps-form input[type="number"]{ width: 100px; }
.nps-form .btn{ padding:8px 12px; }
.nps-toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
.nps-quick{ display:flex; gap:6px; flex-wrap:wrap; }
.nps-quick .btn{ padding:6px 10px; font-size:12px; }
#npsCanvas{ width:100%; height:300px; display:block; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
.nps-legend{ font-size:12px; color:#374151; display:flex; gap:12px; align-items:center; }
.nps-legend .dot{ width:10px; height:10px; border-radius:50%; background:#0EA5E9; display:inline-block; }

  
/* ===== Huesped en casa: maleta a la IZQUIERDA del n√∫mero ===== */
td.estado-inhouse{ position: relative; }
td.estado-inhouse::before{
  content: "";
  position: absolute;
  top: 2px;
  left: 4px;
  width: 16px;
  height: 16px;
  background-image: url('https://res.cloudinary.com/dor6za85u/image/upload/v1756963418/4bf66c0f592b61141d7632d164d83d29_f8gnqo.gif');
  background-size: contain;
  background-position: center left;
  background-repeat: no-repeat;
  pointer-events: none;
  opacity: 0.95;
}

  
/* ===== Estado IP Room (IZQUIERDA centrada verticalmente) ===== */
td.estado-iproom{ position: relative; }
td.estado-iproom::before{
  content: "‚úÖ";
  position: absolute;
  left: 4px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  line-height: 1;
  pointer-events: none;
}

/* Si tambi√©n hay maleta (in-house) en la izquierda, corre el ‚úÖ un poco a la derecha para que no choquen */

/* ===== Estrobo global para Salida + Llegada (sin mezclar colores) ===== */
:root{
  --salida-bg:#FEF3C7; /* amarillo suave */
  --salida-bd:#F59E0B;
  --llegada-bg:#DBEAFE; /* azul suave */
  --llegada-bd:#3B82F6;
}
/* Estado base cuando tiene ambas marcas */
td.estado-salida.estado-llegada,
td.estado-llegada.estado-salida{
  background-color: var(--salida-bg) !important;
  box-shadow: inset 0 0 0 1px var(--salida-bd) !important;
}
/* Fase B: cuando <html> tiene la clase .strobeB, cambiamos a llegada */
html.strobeB td.estado-salida.estado-llegada,
html.strobeB td.estado-llegada.estado-salida{
  background-color: var(--llegada-bg) !important;
  box-shadow: inset 0 0 0 1px var(--llegada-bd) !important;
}
/* Respetar reducci√≥n de movimiento: dejamos fijo en amarillo */
@media (prefers-reduced-motion: reduce){
  td.estado-salida.estado-llegada,
  td.estado-llegada.estado-salida{
    animation: none !important;
    background-color: var(--salida-bg) !important;
    box-shadow: inset 0 0 0 1px var(--salida-bd) !important;
  }
}

  
/* === Llegadas Expedia: reemplaza el üõ¨ por insignia 'E' (solo si .marca-expedia) === */
td.estado-llegada.marca-expedia{ position: relative; }
td.estado-llegada.marca-expedia::after{
  content: "E";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  border-radius: 9999px;
  background: #fbbf24;   /* amarillo tipo Expedia */
  color: #111827;        /* super oscuro para contraste */
  font-weight: 900;
  font-size: 11px;
  line-height: 16px;
  text-align: center;
  pointer-events: none;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}

  
/* === Llegadas Booking: usa PNG oficial como icono === */
td.estado-llegada.marca-booking{ position: relative; }
td.estado-llegada.marca-booking::after{
  content: "";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  background-image: url('https://res.cloudinary.com/dor6za85u/image/upload/v1756971021/62c82305f058e2b89bce43a7_vzcrci.png');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  pointer-events: none;
}
/* Si por error una celda tiene ambas marcas, priorizamos mostrar Booking */
td.estado-llegada.marca-expedia.marca-booking::after,
td.estado-llegada.marca-booking.marca-expedia::after{
  background-image: url('https://res.cloudinary.com/dor6za85u/image/upload/v1756971021/62c82305f058e2b89bce43a7_vzcrci.png');
}

  
/* === Llegadas Booking: insignia "B" morada en la celda === */
td.estado-llegada.marca-booking{ position: relative; }
td.estado-llegada.marca-booking::after{
  content: "B";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  border-radius: 9999px;
  background: #6366F1;   /* indigo (Booking) */
  color: #ffffff;
  font-weight: 900;
  font-size: 11px;
  line-height: 16px;
  text-align: center;
  pointer-events: none;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.08);
}
/* Si una celda tiene ambas marcas, forzamos que se vea la 'B' de Booking */
td.estado-llegada.marca-expedia.marca-booking::after,
td.estado-llegada.marca-booking.marca-expedia::after{
  content: "B";
  background: #6366F1;
  color: #ffffff;
}

  
/* === Llegadas VIP: la 'V' dorada sustituye el avi√≥n SOLO si es llegada + VIP === */
td.estado-llegada.marca-vip{ position: relative; }
td.estado-llegada.marca-vip::after{
  content: "V";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  border-radius: 9999px;
  background: #111827; /* negro */
  color: #f59e0b;      /* dorado */
  font-weight: 900;
  font-size: 11px;
  line-height: 16px;
  text-align: center;
  pointer-events: none;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.08);
}
/* Prioridad visual: si tambi√©n tiene Booking o Expedia, muestran su propia insignia */
td.estado-llegada.marca-booking.marca-vip::after{
  content: "B";
  background: #6366F1;
  color: #ffffff;
}
td.estado-llegada.marca-expedia.marca-vip::after{
  content: "E";
  background: #fbbf24;
  color: #111827;
}

  
/* === VIP SIEMPRE visible: si la habitaci√≥n es VIP, muestra 'V' arriba-derecha,
       incluso cuando NO es llegada. Si ES llegada, ocultamos este ::before para
       que act√∫e el ::after (que reemplaza al avi√≥n). */
td.marca-vip{ position: relative; }
td.marca-vip::before{
  content: "V";
  position: absolute;
  top: 2px;
  right: 4px;
  width: 16px;
  height: 16px;
  border-radius: 9999px;
  background: #111827;
  color: #f59e0b;
  font-weight: 900;
  font-size: 11px;
  line-height: 16px;
  text-align: center;
  pointer-events: none;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.08);
}
/* En llegadas, dejamos que el ::after gobierne (V/B/E), as√≠ que ocultamos este ::before */
td.estado-llegada.marca-vip::before{ content: none; }

  
/* === RESTAURAR (pill + modal) === */
.stat-pill.stat-reset{
  background:#fff1f2;           /* rose-50 */
  border-color:#ef4444;         /* red-500 */
}
.stat-pill.stat-reset .label,
.stat-pill.stat-reset .value{ color:#991b1b; } /* red-800 */
.stat-pill.stat-reset span:first-child{
  width:18px;height:18px;display:inline-block;margin-right:6px;
  background:#ef4444;color:#fff;border-radius:9999px;
  font-weight:900;line-height:18px;text-align:center;font-size:12px;
}

/* Modal reset */
#modalReset .modal-box header{
  background:#fff1f2; color:#991b1b; border-bottom:1px solid #ef4444;
  font-weight:800;
}
.reset-warning{
  background:#fff7ed;border:1px solid #fdba74;color:#7c2d12;
  padding:8px 10px;border-radius:8px;margin:8px 0;
}
.reset-grid{ display:grid; gap:10px; }
.reset-grid .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.reset-grid .wide{ width:100%; }
.reset-foot{ display:flex; gap:8px; justify-content:flex-end; }
.reset-foot .danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
.reset-foot .danger[disabled]{ opacity:.5; cursor:not-allowed; }

  
/* === EVENTOS (pill + modal) === */
.stat-pill.stat-eventos{
  background:#ecfeff;            /* sky-50 */
  border-color:#06b6d4;          /* cyan-500 */
}
.stat-pill.stat-eventos .label,
.stat-pill.stat-eventos .value{ color:#0e7490; } /* cyan-700 */
.stat-pill.stat-eventos span:first-child{
  width:18px;height:18px;display:inline-block;margin-right:6px;
  background:#06b6d4;color:#fff;border-radius:9999px;
  font-weight:900;line-height:18px;text-align:center;font-size:12px;
}
/* tabla/lista de eventos en el modal */
.event-row{
  display:grid;
  grid-template-columns:130px 70px 90px 1fr auto;
  gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #e5e7eb;
}
.event-row .title{ font-weight:600;color:#0f172a; }
.event-row .rooms{ font-variant-numeric:tabular-nums;color:#0f172a; }
.event-row .dt{ color:#334155; }
.event-row .actions button{ margin-left:6px; }
.modal-box .wide{ width:100%; }
.modal-box .stack{ display:grid;gap:8px; }
.modal-box .two{ display:grid;gap:8px;grid-template-columns:1fr 1fr; }
@media (max-width:900px){
  .event-row{ grid-template-columns:110px 60px 80px 1fr auto; }
}

  </style>

<style id="catalog-container-styles">
  .catalog-wrap{
    display:block;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
    direction:ltr;
    overflow-anchor:none;
    scroll-snap-type: none;
    padding-left:18px;
    padding-right:8px;
  }
  .catalog-wrap > table.excel{
    width: max-content !important;
    display: block;
  }
</style>


<style>
table.excel td:nth-child(3n){ position:relative; text-align:center; }
td .evt-badge{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  display:inline-flex; align-items:center; justify-content:center;
  width:18px; height:18px; border-radius:9999px;
  font-size:12px; line-height:18px; cursor:pointer;
  border:2px solid #06b6d4; background:#ecfeff; color:#0e7490; box-shadow:0 2px 6px rgba(0,0,0,.08);
  z-index:2;
}
.evt-pop{
  position:absolute; z-index:40; top:100%; left:50%; transform:translate(-50%, 8px);
  width:260px; background:#fff; border:1px solid #e5e7eb; border-radius:12px;
  box-shadow:0 14px 32px rgba(0,0,0,.18); padding:10px; text-align:left;
}
.evt-pop h4{ margin:0 0 6px; font:700 13px system-ui; color:#0f172a; }
.evt-pop .row{ font:600 12px/1.35 system-ui; color:#334155; margin:4px 0; }
.evt-pop .nota{ font:500 12px/1.4 system-ui; color:#475569; border-top:1px dashed #e5e7eb; margin-top:6px; padding-top:6px; }
.evt-pop .close{ position:absolute; top:6px; right:8px; font:700 12px system-ui; color:#64748b; cursor:pointer; }
</style>


<style>
.cal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:1000}
.cal-backdrop.show{display:flex}
.cal-modal{width:min(1200px,96vw);height:min(760px,92vh);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
.cal-head .title{font:700 18px system-ui;color:#0f172a;display:flex;align-items:center;gap:10px}
.cal-head .controls{display:flex;align-items:center;gap:10px}
.cal-head .pill{padding:6px 10px;border:1px solid #e5e7eb;border-radius:9999px;background:#fff;font-weight:700}
.cal-body{display:grid;grid-template-columns:1fr 340px;gap:0;height:100%}
.cal-grid-wrap{padding:12px 16px;overflow:auto}
.cal-aside{border-left:1px solid #e5e7eb;padding:12px 12px;display:flex;flex-direction:column;gap:10px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-dow{font:700 12px system-ui;color:#334155;text-align:center;padding:4px 0}
.cal-cell{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;min-height:100px;display:flex;flex-direction:column;gap:6px;position:relative}
.cal-cell .date{font:800 12px system-ui;color:#0f172a;align-self:flex-start;background:#f1f5f9;padding:2px 6px;border-radius:9999px}
.cal-cell.today .date{background:#dbeafe;color:#1e40af}
.cal-cell .count{position:absolute;top:8px;right:8px;font:800 11px system-ui;color:#0f172a;background:#ecfeff;border:1px solid #67e8f9;border-radius:9999px;padding:2px 6px}
.cal-cell .chips{display:flex;flex-wrap:wrap;gap:4px}
.cal-chip{font:700 11px system-ui;border-radius:9999px;padding:2px 6px;border:1px solid #e5e7eb;background:#fff}
.cal-chip.cumple{background:#fef3c7;border-color:#f59e0b}
.cal-chip.vip{background:#111827;border-color:#f59e0b;color:#f59e0b}
.cal-chip.corporativo{background:#e2e8f0;border-color:#334155}
.cal-chip.boda{background:#fff;border-color:#f59e0b}
.cal-chip.aniverso{background:#e0f2fe;border-color:#2563eb}
.cal-chip.honeymoon{background:#f5f3ff;border-color:#a78bfa}
.cal-chip.shooting{background:#f3f4f6;border-color:#6b7280}
.cal-chip.amenidad{background:#dcfce7;border-color:#22c55e}
.cal-aside h3{margin:0;font:800 14px system-ui;color:#0f172a}
.cal-aside .muted{color:#64748b;font:600 12px system-ui}
.cal-field{display:flex;flex-direction:column;gap:4px}
.cal-field input,.cal-field textarea,.cal-field select{border:1px solid #e5e7eb;border-radius:10px;padding:8px;font:600 13px system-ui;outline:none}
.cal-actions{display:flex;gap:8px}
.cal-btn{padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font:800 12px system-ui}
.cal-btn.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
.cal-btn.warn{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.cal-close{cursor:pointer;font:800 14px system-ui;color:#0f172a}
</style>


<style>
.hist-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:1001}
.hist-backdrop.show{display:flex}
.hist-modal{width:min(1200px,96vw);height:min(760px,92vh);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
.hist-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
.hist-head .title{font:700 18px system-ui;color:#0f172a;display:flex;align-items:center;gap:10px}
.hist-controls{display:flex;align-items:center;gap:10px}
.hist-controls .field{display:flex;align-items:center;gap:6px;font:600 12px system-ui;color:#334155}
.hist-controls input,.hist-controls select{border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;font:600 12px system-ui}
.hist-controls .btn{padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:800 12px system-ui;cursor:pointer}
.hist-controls .primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
.hist-body{display:flex;flex-direction:column;height:100%}
.hist-view{flex:1;overflow:auto;background:#fff}
.hist-view .snapshot{min-width:900px;padding:12px}
.hist-close{cursor:pointer;font:800 14px system-ui;color:#0f172a}
</style>

</head>

<body><div id="sbStatus" style="position:fixed;top:8px;right:8px;z-index:1200;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:9999px;padding:4px 8px;font:700 11px system-ui;color:#0f172a;display:none">SB: ‚Ä¶</div>>
  <div class="page-wrap">
    <header class="header-sabana">
      <img class="logo"
           src="https://res.cloudinary.com/dor6za85u/image/upload/v1755122245/logo_paradisus_rgb_zrms1f.png"
           alt="Logo del hotel">

      <div class="header-text">
        <h1 class="page-title">S√°bana de Operaci√≥n</h1>
        <div class="meta-line">
          <span class="icon">üìÖ</span>
          <span id="fecha">‚Äî</span>
        </div>
        <div class="meta-line">
          <span class="icon">üïí</span>
          <span id="hora" class="time">‚Äî</span>
        </div>
      </div>

      <div class="header-actions" role="toolbar" aria-label="Filtros de habitaciones">
        <button type="button" class="tool-btn btn-salidas"  aria-pressed="false" id="btnSalidas">üõ´ Salidas <span class="count" id="countSalidas">(0)</span></button>
        <button type="button" class="tool-btn btn-llegadas" aria-pressed="false" id="btnLlegadas">üõ¨ Llegadas <span class="count" id="countLlegadas">(0)</span></button>
        <button type="button" class="tool-btn btn-ocupadas" aria-pressed="false" id="btnOcupadas">üõå Ocupadas <span class="count" id="countOcupadas">(0)</span></button>
        <button type="button" class="tool-btn btn-fuera"    aria-pressed="false" id="btnFuera">üöß Fuera de Servicio <span class="count" id="countFuera">(0)</span></button>
        <button type="button" class="tool-btn btn-showroom" aria-pressed="false" id="btnShowroom">üìç Show Room <span class="count" id="countShowroom">(0)</span></button>
      </div>

      <!-- Barra de m√©tricas -->
      <div class="metrics-bar" role="group" aria-label="Indicadores">
        <button type="button" class="stat-pill stat-ocupacion" id="mOcup">
          <span>üè®</span><span class="label">Ocupaci√≥n</span><span class="value" id="vOcup">--%</span>
        </button>

        <button type="button" class="stat-pill stat-nps" id="mNps">
          <span>üìä</span><span class="label">NPS</span><span class="value" id="vNps">--</span>
        </button>

        <button type="button" class="stat-pill stat-queue" id="mQueue">
          <span>üë•</span><span class="label">QUEUE</span><span class="value" id="vQueue">--</span>
        </button>

        <button type="button" class="stat-pill stat-ip" id="mIp">
          <span>‚úÖ</span><span class="label">IP Room</span><span class="value" id="vIp">--</span>
        </button>

        <!-- Canales -->
        <button type="button" class="stat-pill stat-expedia" id="mExpedia">
          <span>üß≥</span><span class="label">Expedia</span><span class="value" id="vExpedia">--</span>
        </button>

        <button type="button" class="stat-pill stat-booking" id="mBooking">
          <span>üè∑Ô∏è</span><span class="label">Booking</span><span class="value" id="vBooking">--</span>
        </button>

        <button type="button" class="stat-pill stat-vips" id="mVips">
          <span>üëë</span><span class="label">VIPs</span><span class="value" id="vVips">--</span>
        </button>
        <button type="button" class="stat-pill stat-eventos" id="mEventos" title="Gestionar eventos">
          <span>‚òÖ</span><span class="label">Eventos</span><span class="value" id="vEventos">0</span>
        </button>
<button type="button" class="stat-pill" id="btnCalendario">üìÖ Calendario</button>
<button type="button" class="stat-pill" id="btnSBForce">‚Üª Actualizar</button>
<button type="button" class="stat-pill" id="btnHistorico">üóÇ Hist√≥rico</button>
        <button type="button" class="stat-pill stat-reset" id="mReset" title="Restaurar (vaciar tabla)">
          <span>‚ü≤</span><span class="label">Restaurar</span><span class="value">‚Äî</span>
        </button>
      </div>
    </header>

    <div class="table-scroller" id="scroller">
      <div class="catalog-wrap"><table class="excel">
  <tbody>
    <tr>
      <td>1211</td><td class="tipo k">K</td><td>-</td><td>1321</td><td class="tipo d">D</td><td>-</td><td>1508</td><td class="tipo d">D</td><td>-</td><td>2208</td><td class="tipo d">D</td><td>-</td><td>2404</td><td class="tipo d">D</td><td>-</td><td>3030</td><td class="tipo k">K</td><td>-</td><td>3201</td><td class="tipo d">D</td><td>-</td><td>3302</td><td class="tipo d">D</td><td>-</td><td>4203</td><td class="tipo k">K</td><td>-</td><td>4305</td><td class="tipo d">D</td><td>-</td><td>4407</td><td class="tipo d">D</td><td>-</td><td>4509</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1212</td><td class="tipo d">D</td><td>-</td><td>1322</td><td class="tipo k">K</td><td>-</td><td>1509</td><td class="tipo k">K</td><td>-</td><td>2209</td><td class="tipo k">K</td><td>-</td><td>2405</td><td class="tipo d">D</td><td>-</td><td>3101</td><td class="tipo k">K</td><td>-</td><td>3202</td><td class="tipo d">D</td><td>-</td><td>3303</td><td class="tipo d">D</td><td>-</td><td>4204</td><td class="tipo d">D</td><td>-</td><td>4306</td><td class="tipo k">K</td><td>-</td><td>4408</td><td class="tipo d">D</td><td>-</td><td>4510</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1214</td><td class="tipo k">K</td><td>-</td><td>1401</td><td class="tipo k">K</td><td>-</td><td>1510</td><td class="tipo d">D</td><td>-</td><td>2210</td><td class="tipo d">D</td><td>-</td><td>2406</td><td class="tipo d">D</td><td>-</td><td>3102</td><td class="tipo k">K</td><td>-</td><td>3203</td><td class="tipo d">D</td><td>-</td><td>3304</td><td class="tipo d">D</td><td>-</td><td>4205</td><td class="tipo d">D</td><td>-</td><td>4307</td><td class="tipo d">D</td><td>-</td><td>4409</td><td class="tipo d">D</td><td>-</td><td>4511</td><td class="tipo k">K</td><td>-</td>
    </tr>
   <tr>
      <td>1215</td><td class="tipo d">D</td><td>-</td><td>1402</td><td class="tipo d">D</td><td>-</td><td>1511</td><td class="tipo k">K</td><td>-</td><td>2211</td><td class="tipo k">K</td><td>-</td><td>2407</td><td class="tipo k">K</td><td>-</td><td>3103</td><td class="tipo k">K</td><td>-</td><td>3204</td><td class="tipo d">D</td><td>-</td><td>3305</td><td class="tipo d">D</td><td>-</td><td>4206</td><td class="tipo k">K</td><td>-</td><td>4308</td><td class="tipo d">D</td><td>-</td><td>4410</td><td class="tipo k">K</td><td>-</td><td>4512</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1216</td><td class="tipo k">K</td><td>-</td><td>1403</td><td class="tipo k">K</td><td>-</td><td>1512</td><td class="tipo d">D</td><td>-</td><td>2212</td><td class="tipo d">D</td><td>-</td><td>2408</td><td class="tipo k">K</td><td>-</td><td>3104</td><td class="tipo k">K</td><td>-</td><td>3205</td><td class="tipo d">D</td><td>-</td><td>3306</td><td class="tipo d">D</td><td>-</td><td>4207</td><td class="tipo d">D</td><td>-</td><td>4309</td><td class="tipo k">K</td><td>-</td><td>4411</td><td class="tipo k">K</td><td>-</td><td>4514</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1217</td><td class="tipo d">D</td><td>-</td><td>1404</td><td class="tipo d">D</td><td>-</td><td>1514</td><td class="tipo k">K</td><td>-</td><td>2214</td><td class="tipo k">K</td><td>-</td><td>2409</td><td class="tipo d">D</td><td>-</td><td>3105</td><td class="tipo k">K</td><td>-</td><td>3206</td><td class="tipo d">D</td><td>-</td><td>3307</td><td class="tipo k">K</td><td>-</td><td>4208</td><td class="tipo d">D</td><td>-</td><td>4310</td><td class="tipo d">D</td><td>-</td><td>4412</td><td class="tipo d">D</td><td>-</td><td>4515</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1218</td><td class="tipo k">K</td><td>-</td><td>1405</td><td class="tipo k">K</td><td>-</td><td>1515</td><td class="tipo d">D</td><td>-</td><td>2215</td><td class="tipo d">D</td><td>-</td><td>2410</td><td class="tipo k">K</td><td>-</td><td>3106</td><td class="tipo k">K</td><td>-</td><td>3207</td><td class="tipo k">K</td><td>-</td><td>3308</td><td class="tipo k">K</td><td>-</td><td>4209</td><td class="tipo k">K</td><td>-</td><td>4311</td><td class="tipo k">K</td><td>-</td><td>4414</td><td class="tipo k">K</td><td>-</td><td>4516</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1219</td><td class="tipo d">D</td><td>-</td><td>1406</td><td class="tipo d">D</td><td>-</td><td>1516</td><td class="tipo k">K</td><td>-</td><td>2216</td><td class="tipo k">K</td><td>-</td><td>2411</td><td class="tipo d">D</td><td>-</td><td>3107</td><td class="tipo k">K</td><td>-</td><td>3208</td><td class="tipo k">K</td><td>-</td><td>3309</td><td class="tipo k">K</td><td>-</td><td>4210</td><td class="tipo d">D</td><td>-</td><td>4312</td><td class="tipo d">D</td><td>-</td><td>4415</td><td class="tipo k">K</td><td>-</td><td>4517</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1220</td><td class="tipo k">K</td><td>-</td><td>1407</td><td class="tipo k">K</td><td>-</td><td>1517</td><td class="tipo d">D</td><td>-</td><td>2217</td><td class="tipo d">D</td><td>-</td><td>2412</td><td class="tipo k">K</td><td>-</td><td>3108</td><td class="tipo k">K</td><td>-</td><td>3209</td><td class="tipo k">K</td><td>-</td><td>3310</td><td class="tipo k">K</td><td>-</td><td>4211</td><td class="tipo k">K</td><td>-</td><td>4314</td><td class="tipo d">D</td><td>-</td><td>4416</td><td class="tipo d">D</td><td>-</td><td>4518</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1221</td><td class="tipo d">D</td><td>-</td><td>1408</td><td class="tipo d">D</td><td>-</td><td>1518</td><td class="tipo k">K</td><td>-</td><td>2218</td><td class="tipo k">K</td><td>-</td><td>2414</td><td class="tipo k">K</td><td>-</td><td>3109</td><td class="tipo k">K</td><td>-</td><td>3210</td><td class="tipo k">K</td><td>-</td><td>3311</td><td class="tipo k">K</td><td>-</td><td>4212</td><td class="tipo d">D</td><td>-</td><td>4315</td><td class="tipo k">K</td><td>-</td><td>4417</td><td class="tipo k">K</td><td>-</td><td>4519</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1222</td><td class="tipo k">K</td><td>-</td><td>1409</td><td class="tipo d">D</td><td>-</td><td>1519</td><td class="tipo d">D</td><td>-</td><td>2301</td><td class="tipo k">K</td><td>-</td><td>2415</td><td class="tipo d">D</td><td>-</td><td>3110</td><td class="tipo k">K</td><td>-</td><td>3211</td><td class="tipo k">K</td><td>-</td><td>3312</td><td class="tipo k">K</td><td>-</td><td>4214</td><td class="tipo k">K</td><td>-</td><td>4316</td><td class="tipo d">D</td><td>-</td><td>4418</td><td class="tipo d">D</td><td>-</td><td>4520</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1301</td><td class="tipo d">D</td><td>-</td><td>1410</td><td class="tipo k">K</td><td>-</td><td>1520</td><td class="tipo k">K</td><td>-</td><td>2302</td><td class="tipo d">D</td><td>-</td><td>2416</td><td class="tipo d">D</td><td>-</td><td>3111</td><td class="tipo k">K</td><td>-</td><td>3212</td><td class="tipo k">K</td><td>-</td><td>3320</td><td class="tipo k">K</td><td>-</td><td>4215</td><td class="tipo k">K</td><td>-</td><td>4317</td><td class="tipo k">K</td><td>-</td><td>4419</td><td class="tipo k">K</td><td>-</td><td>4521</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1302</td><td class="tipo k">K</td><td>-</td><td>1411</td><td class="tipo k">K</td><td>-</td><td>1521</td><td class="tipo d">D</td><td>-</td><td>2303</td><td class="tipo d">D</td><td>-</td><td>2417</td><td class="tipo k">K</td><td>-</td><td>3112</td><td class="tipo k">K</td><td>-</td><td>3214</td><td class="tipo k">K</td><td>-</td><td>3321</td><td class="tipo k">K</td><td>-</td><td>4216</td><td class="tipo d">D</td><td>-</td><td>4318</td><td class="tipo k">K</td><td>-</td><td>4420</td><td class="tipo d">D</td><td>-</td><td>4522</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1303</td><td class="tipo d">D</td><td>-</td><td>1412</td><td class="tipo d">D</td><td>-</td><td>1522</td><td class="tipo k">K</td><td>-</td><td>2304</td><td class="tipo k">K</td><td>-</td><td>2418</td><td class="tipo k">K</td><td>-</td><td>3114</td><td class="tipo k">K</td><td>-</td><td>3215</td><td class="tipo d">D</td><td>-</td><td>3322</td><td class="tipo k">K</td><td>-</td><td>4217</td><td class="tipo k">K</td><td>-</td><td>4319</td><td class="tipo d">D</td><td>-</td><td>4421</td><td class="tipo k">K</td><td>-</td><td>4523</td><td class="tipo k">K</td><td>-</td>
    </tr>
     <tr>
      <td>1304</td><td class="tipo k">K</td><td>-</td><td>1414</td><td class="tipo d">D</td><td>-</td><td>2109</td><td class="tipo k">K</td><td>-</td><td>2305</td><td class="tipo d">D</td><td>-</td><td>3014</td><td class="tipo k">K</td><td>-</td><td>3115</td><td class="tipo k">K</td><td>-</td><td>3216</td><td class="tipo k">K</td><td>-</td><td>3323</td><td class="tipo k">K</td><td>-</td><td>4218</td><td class="tipo k">K</td><td>-</td><td>4320</td><td class="tipo k">K</td><td>-</td><td>4422</td><td class="tipo d">D</td><td>-</td><td>4524</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1305</td><td class="tipo d">D</td><td>-</td><td>1415</td><td class="tipo d">D</td><td>-</td><td>2110</td><td class="tipo d">D</td><td>-</td><td>2306</td><td class="tipo d">D</td><td>-</td><td>3015</td><td class="tipo k">K</td><td>-</td><td>3116</td><td class="tipo k">K</td><td>-</td><td>3217</td><td class="tipo k">K</td><td>-</td><td>3324</td><td class="tipo k">K</td><td>-</td><td>4219</td><td class="tipo d">D</td><td>-</td><td>4321</td><td class="tipo d">D</td><td>-</td><td>4423</td><td class="tipo k">K</td><td>-</td><td>4525</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1306</td><td class="tipo k">K</td><td>-</td><td>1416</td><td class="tipo k">K</td><td>-</td><td>2111</td><td class="tipo k">K</td><td>-</td><td>2307</td><td class="tipo k">K</td><td>-</td><td>3016</td><td class="tipo k">K</td><td>-</td><td>3117</td><td class="tipo k">K</td><td>-</td><td>3218</td><td class="tipo d">D</td><td>-</td><td>3325</td><td class="tipo k">K</td><td>-</td><td>4220</td><td class="tipo k">K</td><td>-</td><td>4322</td><td class="tipo k">K</td><td>-</td><td>4424</td><td class="tipo d">D</td><td>-</td><td>4526</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1307</td><td class="tipo d">D</td><td>-</td><td>1417</td><td class="tipo d">D</td><td>-</td><td>2112</td><td class="tipo d">D</td><td>-</td><td>2308</td><td class="tipo k">K</td><td>-</td><td>3017</td><td class="tipo k">K</td><td>-</td><td>3118</td><td class="tipo k">K</td><td>-</td><td>3219</td><td class="tipo k">K</td><td>-</td><td>3326</td><td class="tipo k">K</td><td>-</td><td>4221</td><td class="tipo d">D</td><td>-</td><td>4323</td><td class="tipo d">D</td><td>-</td><td>4425</td><td class="tipo k">K</td><td>-</td><td>4527</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1308</td><td class="tipo k">K</td><td>-</td><td>1418</td><td class="tipo k">K</td><td>-</td><td>2114</td><td class="tipo k">K</td><td>-</td><td>2309</td><td class="tipo d">D</td><td>-</td><td>3018</td><td class="tipo k">K</td><td>-</td><td>3119</td><td class="tipo k">K</td><td>-</td><td>3220</td><td class="tipo k">K</td><td>-</td><td>3327</td><td class="tipo k">K</td><td>-</td><td>4222</td><td class="tipo k">K</td><td>-</td><td>4324</td><td class="tipo d">D</td><td>-</td><td>4426</td><td class="tipo d">D</td><td>-</td><td>4528</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1309</td><td class="tipo d">D</td><td>-</td><td>1419</td><td class="tipo d">D</td><td>-</td><td>2115</td><td class="tipo d">D</td><td>-</td><td>2310</td><td class="tipo k">K</td><td>-</td><td>3019</td><td class="tipo k">K</td><td>-</td><td>3120</td><td class="tipo d">D</td><td>-</td><td>3221</td><td class="tipo k">K</td><td>-</td><td>3328</td><td class="tipo k">K</td><td>-</td><td>4223</td><td class="tipo d">D</td><td>-</td><td>4325</td><td class="tipo k">K</td><td>-</td><td>4427</td><td class="tipo d">D</td><td>-</td><td>4529</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1310</td><td class="tipo k">K</td><td>-</td><td>1420</td><td class="tipo k">K</td><td>-</td><td>2116</td><td class="tipo k">K</td><td>-</td><td>2311</td><td class="tipo d">D</td><td>-</td><td>3020</td><td class="tipo k">K</td><td>-</td><td>3121</td><td class="tipo k">K</td><td>-</td><td>3222</td><td class="tipo k">K</td><td>-</td><td>3329</td><td class="tipo k">K</td><td>-</td><td>4224</td><td class="tipo k">K</td><td>-</td><td>4326</td><td class="tipo d">D</td><td>-</td><td>4428</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1311</td><td class="tipo k">K</td><td>-</td><td>1421</td><td class="tipo d">D</td><td>-</td><td>2117</td><td class="tipo d">D</td><td>-</td><td>2312</td><td class="tipo d">D</td><td>-</td><td>3021</td><td class="tipo k">K</td><td>-</td><td>3122</td><td class="tipo d">D</td><td>-</td><td>3223</td><td class="tipo k">K</td><td>-</td><td>3330</td><td class="tipo k">K</td><td>-</td><td>4225</td><td class="tipo d">D</td><td>-</td><td>4327</td><td class="tipo k">K</td><td>-</td><td>4429</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1312</td><td class="tipo d">D</td><td>-</td><td>1422</td><td class="tipo k">K</td><td>-</td><td>2118</td><td class="tipo k">K</td><td>-</td><td>2314</td><td class="tipo k">K</td><td>-</td><td>3022</td><td class="tipo k">K</td><td>-</td><td>3123</td><td class="tipo k">K</td><td>-</td><td>3224</td><td class="tipo k">K</td><td>-</td><td>4111</td><td class="tipo k">K</td><td>-</td><td>4226</td><td class="tipo d">D</td><td>-</td><td>4328</td><td class="tipo d">D</td><td>-</td><td>4501</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1314</td><td class="tipo d">D</td><td>-</td><td>1501</td><td class="tipo k">K</td><td>-</td><td>2201</td><td class="tipo k">K</td><td>-</td><td>2315</td><td class="tipo d">D</td><td>-</td><td>3023</td><td class="tipo k">K</td><td>-</td><td>3124</td><td class="tipo k">K</td><td>-</td><td>3225</td><td class="tipo k">K</td><td>-</td><td>4112</td><td class="tipo d">D</td><td>-</td><td>4227</td><td class="tipo k">K</td><td>-</td><td>4329</td><td class="tipo k">K</td><td>-</td><td>4502</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1315</td><td class="tipo k">K</td><td>-</td><td>1502</td><td class="tipo d">D</td><td>-</td><td>2202</td><td class="tipo d">D</td><td>-</td><td>2316</td><td class="tipo d">D</td><td>-</td><td>3024</td><td class="tipo k">K</td><td>-</td><td>3125</td><td class="tipo d">D</td><td>-</td><td>3226</td><td class="tipo k">K</td><td>-</td><td>4114</td><td class="tipo d">D</td><td>-</td><td>4228</td><td class="tipo d">D</td><td>-</td><td>4401</td><td class="tipo k">K</td><td>-</td><td>4503</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1316</td><td class="tipo d">D</td><td>-</td><td>1503</td><td class="tipo k">K</td><td>-</td><td>2203</td><td class="tipo d">D</td><td>-</td><td>2317</td><td class="tipo k">K</td><td>-</td><td>3025</td><td class="tipo k">K</td><td>-</td><td>3126</td><td class="tipo k">K</td><td>-</td><td>3227</td><td class="tipo k">K</td><td>-</td><td>4115</td><td class="tipo d">D</td><td>-</td><td>4229</td><td class="tipo k">K</td><td>-</td><td>4402</td><td class="tipo k">K</td><td>-</td><td>4504</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1317</td><td class="tipo k">K</td><td>-</td><td>1504</td><td class="tipo d">D</td><td>-</td><td>2204</td><td class="tipo k">K</td><td>-</td><td>2318</td><td class="tipo k">K</td><td>-</td><td>3026</td><td class="tipo k">K</td><td>-</td><td>3127</td><td class="tipo k">K</td><td>-</td><td>3228</td><td class="tipo k">K</td><td>-</td><td>4116</td><td class="tipo d">D</td><td>-</td><td>4301</td><td class="tipo k">K</td><td>-</td><td>4403</td><td class="tipo d">D</td><td>-</td><td>4505</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1318</td><td class="tipo d">D</td><td>-</td><td>1505</td><td class="tipo k">K</td><td>-</td><td>2205</td><td class="tipo d">D</td><td>-</td><td>2401</td><td class="tipo k">K</td><td>-</td><td>3027</td><td class="tipo k">K</td><td>-</td><td>3128</td><td class="tipo d">D</td><td>-</td><td>3229</td><td class="tipo k">K</td><td>-</td><td>4117</td><td class="tipo k">K</td><td>-</td><td>4302</td><td class="tipo d">D</td><td>-</td><td>4404</td><td class="tipo k">K</td><td>-</td><td>4506</td><td class="tipo d">D</td><td>-</td>
    </tr>
    <tr>
      <td>1319</td><td class="tipo k">K</td><td>-</td><td>1506</td><td class="tipo d">D</td><td>-</td><td>2206</td><td class="tipo d">D</td><td>-</td><td>2402</td><td class="tipo d">D</td><td>-</td><td>3028</td><td class="tipo k">K</td><td>-</td><td>3129</td><td class="tipo k">K</td><td>-</td><td>3230</td><td class="tipo k">K</td><td>-</td><td>4201</td><td class="tipo k">K</td><td>-</td><td>4303</td><td class="tipo k">K</td><td>-</td><td>4405</td><td class="tipo d">D</td><td>-</td><td>4507</td><td class="tipo k">K</td><td>-</td>
    </tr>
    <tr>
      <td>1320</td><td class="tipo d">D</td><td>-</td><td>1507</td><td class="tipo k">K</td><td>-</td><td>2207</td><td class="tipo k">K</td><td>-</td><td>2403</td><td class="tipo k">K</td><td>-</td><td>3029</td><td class="tipo k">K</td><td>-</td><td>3130</td><td class="tipo k">K</td><td>-</td><td>3301</td><td class="tipo d">D</td><td>-</td><td>4202</td><td class="tipo d">D</td><td>-</td><td>4304</td><td class="tipo d">D</td><td>-</td><td>4406</td><td class="tipo k">K</td><td>-</td><td>4508</td><td class="tipo d">D</td><td>-</td>
    </tr>
  </tbody>
</table>
    </div></div>
  </div>

  <!-- Modal de Habitaci√≥n (informativo) -->
  <div class="modal-backdrop" id="modalHabitacion" hidden>
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header><span id="modalTitle">Habitaci√≥n</span></header>
      <div class="content" id="modalContent">pendientes por incorporar</div>
      <footer>
        <button class="btn" id="btnCerrar">Cerrar</button>
        <button class="btn primary" id="btnAceptar">Aceptar</button>
      </footer>
    </div>
  </div>

  <!-- Modal de Gesti√≥n de Salidas -->
  <div class="modal-backdrop" id="modalSalidas" hidden>
    <div class="modal-box modal-salidas" role="dialog" aria-modal="true" aria-labelledby="modalSalidasTitle">
      <header class="salidas-header"><span class="salidas-icon">üõ´</span><span id="modalSalidasTitle">Gestionar Salidas</span><span class="salidas-badge" id="salidasBadge">(0)</span></header>
      
      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeSal" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeSal" value="remove"> Quitar</label>
            </div>
            <textarea id="inputSalidas" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio o nueva l√≠nea"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas.<br>Ignoramos duplicados y validamos que existan en la tabla.</div>
            <div id="invalidMsg" class="helper"></div>
          </div>
          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente:</strong> <span id="countSalidasInside">0</span></div>
              <div class="chips-tools">
                <input id="filterSalidas" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopySalidas" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsSalidas"></div></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn warn" id="btnLimpiarSalidas">Limpiar todas</button>
        <button class="btn" id="btnCerrarSalidas">Cerrar</button>
        <button class="btn primary" id="btnAplicarSalidas">Aplicar</button>
      </footer>

    </div>
  </div>

  <!-- Modal de Gesti√≥n de Llegadas -->
  <div class="modal-backdrop" id="modalLlegadas" hidden>
    <div class="modal-box modal-llegadas" role="dialog" aria-modal="true" aria-labelledby="modalLlegadasTitle">
      <header class="llegadas-header">
        <span class="llegadas-icon">üõ¨</span>
        <span id="modalLlegadasTitle">Gestionar Llegadas</span>
        <span class="llegadas-badge" id="llegadasBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeArr" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeArr" value="remove"> Quitar</label>
            </div>
            <textarea id="inputLlegadas" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio, punto o guion"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas. Duplicados se ignoran.</div>
            <div id="invalidMsgArr" class="helper"></div>
          </div>
          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente:</strong> <span id="countLlegadasInside">0</span></div>
              <div class="chips-tools">
                <input id="filterLlegadas" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopyLlegadas" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsLlegadas"></div></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn warn" id="btnLimpiarLlegadas">Limpiar todas</button>
        <button class="btn" id="btnCerrarLlegadas">Cerrar</button>
        <button class="btn primary" id="btnAplicarLlegadas">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal de Gesti√≥n de Ocupadas -->
  <div class="modal-backdrop" id="modalOcupadas" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalOcupadasTitle">
      <header class="ocupadas-header">
        <span class="ocupadas-icon">üõå</span>
        <span id="modalOcupadasTitle">Gestionar Ocupadas</span>
        <span class="ocupadas-badge" id="ocupadasBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeOcc" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeOcc" value="remove"> Quitar</label>
            </div>
            <textarea id="inputOcupadas" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio, punto o guion"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas. Duplicados se ignoran.</div>
            <div id="invalidMsgOcc" class="helper"></div>
          </div>
          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente:</strong> <span id="countOcupadasInside">0</span></div>
              <div class="chips-tools">
                <input id="filterOcupadas" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopyOcupadas" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsOcupadas"></div></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn warn" id="btnLimpiarOcupadas">Limpiar todas</button>
        <button class="btn" id="btnCerrarOcupadas">Cerrar</button>
        <button class="btn primary" id="btnAplicarOcupadas">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal de Gesti√≥n de Fuera de Servicio -->
  <div class="modal-backdrop" id="modalFuera" hidden>
    <div class="modal-box modal-fuera" role="dialog" aria-modal="true" aria-labelledby="modalFueraTitle">
      <header class="fuera-header">
        <span class="fuera-icon"></span>
        <span id="modalFueraTitle">Gestionar Fuera de Servicio</span>
        <span class="fuera-badge" id="fueraBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeOut" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeOut" value="remove"> Quitar</label>
            </div>
            <textarea id="inputFuera" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio, punto o guion"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas. Duplicados se ignoran.</div>
            <div id="invalidMsgOut" class="helper"></div>
          </div>
          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente:</strong> <span id="countFueraInside">0</span></div>
              <div class="chips-tools">
                <input id="filterFuera" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopyFuera" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsFuera"></div></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn warn" id="btnLimpiarFuera">Limpiar todas</button>
        <button class="btn" id="btnCerrarFuera">Cerrar</button>
        <button class="btn primary" id="btnAplicarFuera">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal de Gesti√≥n de Show Room -->
  <div class="modal-backdrop" id="modalShowroom" hidden>
    <div class="modal-box modal-showroom" role="dialog" aria-modal="true" aria-labelledby="modalShowroomTitle">
      <header class="showroom-header">
        <span class="showroom-icon">üìç</span>
        <span id="modalShowroomTitle">Gestionar Show Room</span>
        <span class="showroom-badge" id="showroomBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeShow" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeShow" value="remove"> Quitar</label>
            </div>
            <textarea id="inputShowroom" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio, punto o guion"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas. Duplicados se ignoran.</div>
            <div id="invalidMsgShow" class="helper"></div>
          </div>
          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente:</strong> <span id="countShowroomInside">0</span></div>
              <div class="chips-tools">
                <input id="filterShowroom" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopyShowroom" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsShowroom"></div></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn warn" id="btnLimpiarShowroom">Limpiar todas</button>
        <button class="btn" id="btnCerrarShowroom">Cerrar</button>
        <button class="btn primary" id="btnAplicarShowroom">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal NPS -->
  <div class="modal-backdrop" id="modalNps" hidden>
    <div class="modal-box modal-nps" role="dialog" aria-modal="true" aria-labelledby="modalNpsTitle">
      <header class="nps-header">
        <span class="nps-icon">üìä</span>
        <span id="modalNpsTitle">Indicador NPS</span>
        <span class="nps-badge" id="npsBadge">--</span>
      </header>

      <div class="content">
        <div class="nps-grid">
          <div class="nps-form">
            <div class="row">
              <label for="npsValueInput"><strong>NPS de hoy:</strong></label>
              <input id="npsValueInput" type="number" min="-100" max="100" step="1" placeholder="0">
              <button class="btn primary" id="btnGuardarNps">Guardar</button>
            </div>
            <div class="row">
              <input id="npsNote" class="search" type="text" placeholder="Nota (opcional): turno, evento...">
            </div>
            <div class="row nps-legend">
              <span class="dot"></span> NPS diario (√∫ltimos d√≠as / meses)
            </div>
          </div>

          <div class="nps-chart">
            <div class="nps-toolbar">
              <div class="nps-quick">
                <button class="btn" data-range="7">7D</button>
                <button class="btn" data-range="30">30D</button>
                <button class="btn" data-range="90">90D</button>
                <button class="btn" data-range="365">1A</button>
                <button class="btn" data-range="all">Todo</button>
              </div>
              <div>
                <label>Desde: <input type="date" id="npsFrom"></label>
                <label>Hasta: <input type="date" id="npsTo"></label>
                <button class="btn" id="btnNpsFiltrar">Filtrar</button>
              </div>
            </div>
            <canvas id="npsCanvas" width="900" height="300"></canvas>
          </div>
        </div>
      </div>

      <footer>
        <button class="btn" id="btnCerrarNps">Cerrar</button>
      </footer>
    </div>
  </div>

  <!-- Modal de Gesti√≥n de IP Room -->
  <div class="modal-backdrop" id="modalIpRoom" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalIpRoomTitle">
      <header class="ocupadas-header" style="background:#D1FAE5; color:#065F46; border-bottom-color:#10B981;">
        <span class="ocupadas-icon">‚úÖ</span>
        <span id="modalIpRoomTitle">Gestionar IP Room</span>
        <span class="ocupadas-badge" id="ipRoomBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="mode-row">
              <label><input type="radio" name="modeIp" value="add" checked> Agregar</label>
              <label><input type="radio" name="modeIp" value="remove"> Quitar</label>
            </div>
            <textarea id="inputIpRoom" class="list-input" placeholder="Pega o escribe n√∫meros de habitaci√≥n (4 d√≠gitos), separados por coma, espacio o nueva l√≠nea"></textarea>
            <div class="helper">Ejemplos: <code>1211, 1212, 1401</code> √≥ en l√≠neas separadas. Duplicados se ignoran.</div>
            <div id="invalidMsgIp" class="helper"></div>
          </div>

          <div class="chips-panel">
            <div class="chips-header">
              <div class="helper"><strong>Marcadas actualmente (IP):</strong> <span id="countIpRoomInside">0</span></div>
              <div class="chips-tools">
                <input id="filterIpRoom" class="search" type="search" placeholder="Filtrar...">
                <button class="btn" id="btnCopyIpRoom" title="Copiar lista">Copiar</button>
              </div>
            </div>
            <div class="chips-scroll"><div class="chips" id="chipsIpRoom"></div></div>
          </div>
        </div>
      </div>

      <footer>
        <button class="btn warn" id="btnLimpiarIpRoom">Limpiar todas</button>
        <button class="btn" id="btnCerrarIpRoom">Cerrar</button>
        <button class="btn primary" id="btnAplicarIpRoom">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal Llegadas Expedia -->
  <div class="modal-backdrop" id="modalExpedia" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalExpediaTitle">
      <header class="ocupadas-header" style="background:#FEF9C3;color:#7C2D12;border-bottom-color:#F59E0B;">
        <span class="ocupadas-icon">E</span>
        <span id="modalExpediaTitle">Llegadas (Expedia)</span>
        <span class="ocupadas-badge" id="expediaBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="helper"><strong>Lista Expedia</strong> (coma, espacio o saltos de l√≠nea)</div>
            <textarea id="listExpedia" class="list-input" placeholder="1211, 1212, 1401..."></textarea>
            <div class="chips-tools">
              <button class="btn" id="btnPasteExpedia">Pegar</button>
              <button class="btn" id="btnCopyExpedia">Copiar</button>
              <button class="btn" id="btnLimpiarExpedia">Limpiar</button>
              <span class="helper">Total: <strong id="countExpediaInside">0</strong></span>
            </div>
          </div>
          <div>
            <div class="chips-tools" style="justify-content:flex-end;">
              <input id="filterExpedia" class="search" type="search" placeholder="Filtrar">
            </div>
            <div class="chips-scroll">
              <div id="chipsExpedia"></div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <button class="btn" id="btnCerrarExpedia">Cerrar</button>
        <button class="btn primary" id="btnAplicarExpedia">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal Llegadas Booking -->
  <div class="modal-backdrop" id="modalBooking" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalBookingTitle">
      <header class="ocupadas-header" style="background:#EEF2FF;color:#1E1B4B;border-bottom-color:#6366F1;">
        <span class="ocupadas-icon">B</span>
        <span id="modalBookingTitle">Llegadas (Booking)</span>
        <span class="ocupadas-badge" id="bookingBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="helper"><strong>Lista Booking</strong> (coma, espacio o saltos de l√≠nea)</div>
            <textarea id="listBooking" class="list-input" placeholder="1211, 1212, 1401..."></textarea>
            <div class="chips-tools">
              <button class="btn" id="btnPasteBooking">Pegar</button>
              <button class="btn" id="btnCopyBooking">Copiar</button>
              <button class="btn" id="btnLimpiarBooking">Limpiar</button>
              <span class="helper">Total: <strong id="countBookingInside">0</strong></span>
            </div>
          </div>
          <div>
            <div class="chips-tools" style="justify-content:flex-end;">
              <input id="filterBooking" class="search" type="search" placeholder="Filtrar">
            </div>
            <div class="chips-scroll">
              <div id="chipsBooking"></div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <button class="btn" id="btnCerrarBooking">Cerrar</button>
        <button class="btn primary" id="btnAplicarBooking">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal VIPs -->
  <div class="modal-backdrop" id="modalVips" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalVipsTitle">
      <header class="ocupadas-header" style="background:#FFF7ED;color:#7C2D12;border-bottom-color:#F59E0B;">
        <span class="ocupadas-icon">V</span>
        <span id="modalVipsTitle">Habitaciones VIP</span>
        <span class="ocupadas-badge" id="vipsBadge">(0)</span>
      </header>

      <div class="content">
        <div class="grid-2">
          <div>
            <div class="helper"><strong>Lista VIP</strong> (coma, espacio o saltos de l√≠nea)</div>
            <textarea id="listVips" class="list-input" placeholder="1211, 1212, 1401..."></textarea>
            <div class="chips-tools">
              <button class="btn" id="btnPasteVips">Pegar</button>
              <button class="btn" id="btnCopyVips">Copiar</button>
              <button class="btn" id="btnLimpiarVips">Limpiar</button>
              <span class="helper">Total: <strong id="countVipsInside">0</strong></span>
            </div>
          </div>
          <div>
            <div class="chips-tools" style="justify-content:flex-end;">
              <input id="filterVips" class="search" type="search" placeholder="Filtrar">
            </div>
            <div class="chips-scroll">
              <div id="chipsVips"></div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <button class="btn" id="btnCerrarVips">Cerrar</button>
        <button class="btn primary" id="btnAplicarVips">Aplicar</button>
      </footer>
    </div>
  </div>

  <!-- Modal RESTAURAR -->
  <div class="modal-backdrop" id="modalReset" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalResetTitle">
      <header>
        <span>‚ü≤ Restaurar S√°bana</span>
      </header>
      <div class="content">
        <div class="reset-warning">
          <strong>Atenci√≥n:</strong> Esta acci√≥n <em>vaciar√° todas las marcas</em> de la tabla (Llegadas, Salidas, Ocupadas, In‚ÄëHouse, IP Room, VIP, Expedia/Booking, Show Room).
          Para confirmar, escribe tu <strong>matr√≠cula</strong> y pulsa <strong>Restaurar</strong>.
        </div>
        <div class="reset-grid">
          <div class="two">
            <div>
              <label class="helper"><strong>Matr√≠cula</strong> (obligatoria)</label>
              <div style="display:flex;gap:8px;align-items:center;"><input id="resetMatricula" class="wide" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Ingresa tu matr√≠cula" /><button type="button" class="btn btn-sm" id="btnToggleMatricula" title="Mostrar/ocultar">üëÅÔ∏è</button></div>
              <div class="helper" id="resetMatriculaHint">Escribe tu matr√≠cula para habilitar el bot√≥n.</div>
            </div>
            <div>
              <label class="helper"><strong>Opcional</strong></label>
              <label style="display:flex;gap:8px;align-items:center;">
                <input id="resetAlsoEvents" type="checkbox" />
                <span>Tambi√©n borrar <em>Eventos</em> guardados</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <footer class="reset-foot">
        <button class="btn" id="btnCancelarReset">Cancelar</button>
        <button class="btn danger" id="btnConfirmarReset" disabled>Restaurar</button>
      </footer>
    </div>
  </div>

  <!-- Modal EVENTOS -->
  <div class="modal-backdrop" id="modalEventos" hidden>
    <div class="modal-box modal-ocupadas" role="dialog" aria-modal="true" aria-labelledby="modalEventosTitle">
      <header class="ocupadas-header" style="background:#ecfeff;color:#0e7490;border-bottom-color:#06b6d4;">
        <span class="ocupadas-icon">‚òÖ</span>
        <span id="modalEventosTitle">Gestionar Eventos</span>
        <span class="ocupadas-badge" id="eventosBadge">(0)</span>
      </header>
      <div class="content">
        <div class="stack">
          <div class="two">
            <div>
              <label class="helper"><strong>Tipo/T√≠tulo</strong></label>
              <input id="evtTitle" class="wide" list="evtTitleList" placeholder="Cumplea√±ero, Aniversario, Decoraci√≥n..." />
              <datalist id="evtTitleList"></datalist>
            </div>
            <div>
              <label class="helper"><strong>Fecha y hora</strong></label>
              <input id="evtDateTime" type="datetime-local" class="wide" />
            </div>
          </div>
          <div class="two">
            <div>
              <label class="helper"><strong>Habitaci√≥n(es)</strong></label>
              <input id="evtRooms" class="wide" placeholder="1211, 1212 (coma/espacio)" />
            </div>
            <div>
              <label class="helper"><strong>Etiqueta</strong> <span class="helper">(opcional)</span></label>
              <input id="evtTag" class="wide" placeholder="cumplea√±os, luna de miel..." />
            </div>
          </div>
          <div>
            <label class="helper"><strong>Especificaciones</strong></label>
            <textarea id="evtSpecs" class="wide" rows="4" placeholder="Detalles, materiales, notas..."></textarea>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn" id="btnLimpiarEvento">Limpiar</button>
            <button class="btn" id="btnCerrarEventos">Cerrar</button>
            <button class="btn primary" id="btnGuardarEvento">Agregar</button>
          </div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;">
        <div class="two" style="align-items:center;">
          <div class="helper"><strong>Eventos guardados</strong></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
            <input id="evtFilter" class="search" type="search" placeholder="Filtrar por palabra/fecha/hab" />
            <button class="btn" id="btnExportEventos" title="Exportar JSON">Exportar</button>
            <button class="btn" id="btnImportEventos" title="Importar JSON">Importar</button>
          </div>
        </div>
        <div id="eventosLista"></div>
      </div>
    </div>
  </div>

>

>

  <script>
  (function(){
    const tz = 'America/Mazatlan';
    const fechaEl = document.getElementById('fecha');
    const horaEl  = document.getElementById('hora');

    // Total de habitaciones del hotel
    const TOTAL_ROOMS = 350;

    function actualizarFechaHora(){
      const now = new Date();
      const fechaStr = new Intl.DateTimeFormat('es-MX', {
        weekday:'long', day:'numeric', month:'long', year:'numeric', timeZone: tz
      }).format(now);
      if (fechaEl) fechaEl.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);

      if (horaEl) horaEl.textContent = new Intl.DateTimeFormat('es-MX', {
        hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone: tz
      }).format(now);
    }
    actualizarFechaHora();
    setInterval(actualizarFechaHora, 1000);

    // Asegurar class="excel"
    const firstTable = document.querySelector('.table-scroller table');
    if (firstTable && !firstTable.classList.contains('excel')) firstTable.classList.add('excel');

    // Mapa numero->celda (para pintar r√°pido)
    const reNum = /^\d{4}$/;
    const roomCellMap = new Map();
    document.querySelectorAll('table.excel td').forEach(td => {
      const txt = td.textContent.trim();
      if (txt === 'K'){ td.classList.add('tipo','k'); }
      if (txt === 'D'){ td.classList.add('tipo','d'); }
      if (reNum.test(txt)){
        roomCellMap.set(txt, td);
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => abrirModalHabitacion(txt));
      }
    });

    // Modal informativo por habitaci√≥n
    const modalHab  = document.getElementById('modalHabitacion');
    const titleEl   = document.getElementById('modalTitle');
    const contentEl = document.getElementById('modalContent');
    const btnCerrar = document.getElementById('btnCerrar');
    const btnAceptar= document.getElementById('btnAceptar');

    // ===== Huesped en casa (per habitaci√≥n) =====
    const vQueue = document.getElementById('vQueue'); // indicador en barra (üë•)
    const inhouseApplied = new Set(); // habitaciones con hu√©sped en casa
    let currentRoom = null;           // # de habitaci√≥n activa en el modal

    function updateInhouseCount(){
      if (vQueue) vQueue.textContent = String(inhouseApplied.size || 0);
    }
    function setRoomInhouse(num, enabled){
      const td = roomCellMap.get(num);
      if (enabled){
        inhouseApplied.add(num);
        if (td) td.classList.add('estado-inhouse');
      } else {
        inhouseApplied.delete(num);
        if (td) td.classList.remove('estado-inhouse');
      }
      updateInhouseCount();
    }


    function abrirModalHabitacion(num){

      if (titleEl)   titleEl.textContent = 'Habitaci√≥n ' + num;
      if (contentEl) contentEl.textContent = 'pendientes por incorporar';
      if (modalHab)  modalHab.hidden = false;
    
  try{
    currentRoom = num;
    if (contentEl){
      contentEl.innerHTML = `
        <div class="row" style="display:flex;align-items:center;gap:10px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input id="chkInhouse" type="checkbox"> <strong>Hu√©sped en casa</strong>
          </label>
          <span class="helper">Activa para marcar esta habitaci√≥n con maleta y sumar al contador.</span>
        </div>
      `;
      const chk = contentEl.querySelector('#chkInhouse');
      if (chk){
        chk.checked = inhouseApplied.has(num);
        chk.addEventListener('change', ()=> setRoomInhouse(num, chk.checked));
      }
    }
  }catch{}

}
    function cerrarModalHabitacion(){ if (modalHab) modalHab.hidden = true; }
    if (modalHab){
      modalHab.addEventListener('click', e => { if (e.target === modalHab) cerrarModalHabitacion(); });
      if (btnCerrar)  btnCerrar.addEventListener('click', cerrarModalHabitacion);
      if (btnAceptar) btnAceptar.addEventListener('click', cerrarModalHabitacion);
      document.addEventListener('keydown', e => { if (e.key === 'Escape') cerrarModalHabitacion(); });
    }

    
    // ====== Gesti√≥n de SALIDAS (correcci√≥n m√≠nima; no altera la tabla ni el modal de habitaci√≥n) ======
    const btnSalidas     = document.getElementById('btnSalidas');
    const modalSalidas   = document.getElementById('modalSalidas');
    const inputSalidas   = document.getElementById('inputSalidas');   // <-- coincide con HTML
    const chipsWrap      = document.getElementById('chipsSalidas');
    const countSalidas   = document.getElementById('countSalidas');

    const btnLimpiar     = document.getElementById('btnLimpiarSalidas');
    const btnCerrarSal   = document.getElementById('btnCerrarSalidas');
    const btnAplicar     = document.getElementById('btnAplicarSalidas');

    const countInsideEl  = document.getElementById('countSalidasInside');
    const filterSalidas  = document.getElementById('filterSalidas');
    const btnCopySalidas = document.getElementById('btnCopySalidas');

    const salidasSet     = new Set(); // estado en edici√≥n (en el modal)
    const salidasApplied = new Set(); // estado aplicado en la tabla

    function parseLista(str){
      if(!str) return [];
      return str
        .split(/[^\d]+/g)       // separa por no-d√≠gitos (coma, espacio, saltos)
        .map(s => s.trim())
        .filter(Boolean)
        .filter(s => /^\d{4}$/.test(s));
    }

    function renderChips(filterText = ''){
      if (!chipsWrap) return;
      chipsWrap.innerHTML = '';
      const arr = Array.from(salidasSet).sort();
      const f = (filterText || '').trim();
      let validCount = 0; let invalidCount = 0;
      for(const num of arr){
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        const isValid = roomCellMap.has(num);
        chip.className = 'chip ' + (isValid ? 'valid' : 'invalid');
        if (isValid) validCount++; else invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          salidasSet.delete(num);
          renderChips(filterSalidas?.value || '');
        });
        chipsWrap.appendChild(chip);
      }
      if (countInsideEl) countInsideEl.textContent = String(salidasSet.size);
    }

    function abrirModalSalidas(){
      salidasSet.clear();
      salidasApplied.forEach(v => salidasSet.add(v));
      renderChips();
      if (inputSalidas) inputSalidas.value = '';
      if (modalSalidas) modalSalidas.hidden = false;
      setTimeout(()=>{ inputSalidas?.focus(); }, 60);
    }
    function cerrarModalSalidas(){ if (modalSalidas) modalSalidas.hidden = true; }

    function aplicarEnTabla(){
      salidasApplied.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) td.classList.remove('estado-salida');
      });
      salidasApplied.clear();
      salidasSet.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) {
          td.classList.add('estado-salida');
          salidasApplied.add(num);
        }
      });
      if (countSalidas) countSalidas.textContent = '(' + salidasApplied.size + ')';
      const badge = document.getElementById('salidasBadge');
      if (badge) badge.textContent = '(' + salidasApplied.size + ')';
    
      recalcOcupacion();
    }

    btnSalidas?.addEventListener('click', abrirModalSalidas);

    btnLimpiar?.addEventListener('click', ()=>{
      salidasSet.clear();
      renderChips(filterSalidas?.value || '');
    });

    btnCerrarSal?.addEventListener('click', cerrarModalSalidas);
    modalSalidas?.addEventListener('click', (e)=>{ if (e.target === modalSalidas) cerrarModalSalidas(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modalSalidas.hidden) cerrarModalSalidas(); });

    btnAplicar?.addEventListener('click', ()=>{
      const modeEl = document.querySelector('input[name="modeSal"]:checked');
      const mode = modeEl ? modeEl.value : 'add';
      const arr = parseLista(inputSalidas?.value || '');

      if (mode === 'add'){
        arr.forEach(n => salidasSet.add(n));
      } else if (mode === 'remove'){
        arr.forEach(n => salidasSet.delete(n));
      }
      renderChips(filterSalidas?.value || '');
      if (inputSalidas) inputSalidas.value = '';
      aplicarEnTabla();
    });

    filterSalidas?.addEventListener('input', (e)=>{
      renderChips(e.target.value || '');
    });

    btnCopySalidas?.addEventListener('click', ()=>{
      const list = Array.from(salidasSet).sort().join(', ');
      navigator.clipboard.writeText(list).catch(()=>{});
    });

    
    // Atajos de teclado en el input:
    // - Backspace con input vac√≠o: borra el √∫ltimo chip
    // - Enter / Ctrl+Enter: aplicar
    inputSalidas?.addEventListener('keydown', (e)=>{
      const val = inputSalidas.value.trim();
      if ((e.key === 'Backspace' || e.key === 'Delete') && val === ''){
        // borrar el √∫ltimo chip
        const last = Array.from(salidasSet).sort().pop();
        if (last){
          salidasSet.delete(last);
          renderChips(filterSalidas?.value || '');
          e.preventDefault();
        }
      } else if (e.key === 'Enter'){
        if (e.ctrlKey || !e.shiftKey){
          e.preventDefault();
          // Simula clic en Aplicar
          btnAplicar?.click();
        }
      }
    });
// ====== M√©tricas / Canales (APIs) ======
    window.updateOcupacion = function(pct){
      const cont = document.getElementById('mOcup');
      const val  = document.getElementById('vOcup');
      if(!cont || !val) return;
      val.textContent = pct + '%';
      cont.classList.remove('is-low','is-mid','is-high');
      if (pct >= 85)      cont.classList.add('is-high');
      else if (pct >= 60) cont.classList.add('is-mid');
      else                cont.classList.add('is-low');
    }
    window.updateNPS = function(nps){
      const cont = document.getElementById('mNps');
      const val  = document.getElementById('vNps');
      if(!cont || !val) return;
      val.textContent = nps;
      cont.classList.remove('is-low','is-mid','is-high');
      if (nps >= 50)       cont.classList.add('is-low');
      else if (nps >= 0)   cont.classList.add('is-mid');
      else                 cont.classList.add('is-high');
    }
    window.updateQueue = function(qty){
      const val = document.getElementById('vQueue');
      if(val) val.textContent = qty;
    }
    window.updateIpRoom = function(qty){
      const val = document.getElementById('vIp');
      if(val) val.textContent = qty;
    }
    window.updateExpedia = function(qty){
      const val = document.getElementById('vExpedia');
      if(val) val.textContent = qty;
    }
    window.updateBooking = function(qty){
      const val = document.getElementById('vBooking');
      if(val) val.textContent = qty;
    }
    window.updateVips = function(qty){
      const val = document.getElementById('vVips');
      if(val) val.textContent = qty;
    }

    // Ensanchar tabla a ~95% ancho sin tocar alturas
    function widenToViewport(){
      const scroller = document.getElementById('scroller');
      const table = document.querySelector('.table-scroller table.excel');
      if (!scroller || !table) return;

      const basePx = 8, baseNum = 46;
      document.documentElement.style.setProperty('--cell-inline', basePx + 'px');
      document.documentElement.style.setProperty('--num-min', baseNum + 'px');

      const viewportW = scroller.clientWidth;
      const tableW = table.scrollWidth;
      if (!viewportW || !tableW) return;
      if (tableW >= viewportW * 0.995) return;

      const factor = Math.min(2.2, Math.max(1.0, (viewportW*0.95) / tableW));
      const newPx  = Math.round(basePx  * factor);
      const newNum = Math.round(baseNum * factor);

      document.documentElement.style.setProperty('--cell-inline', newPx + 'px');
      document.documentElement.style.setProperty('--num-min', newNum + 'px');
    }
    window.addEventListener('load', widenToViewport);
    window.addEventListener('resize', widenToViewport);
    setTimeout(widenToViewport, 100);

    // ====== Gesti√≥n de LLEGADAS (clonado de Salidas, tema azul) ======
    const btnLlegadas     = document.getElementById('btnLlegadas');
    const modalLlegadas   = document.getElementById('modalLlegadas');
    const inputLlegadas   = document.getElementById('inputLlegadas');
    const chipsLlegadas   = document.getElementById('chipsLlegadas');
    const countLlegadas   = document.getElementById('countLlegadas');

    const btnLimpiarArr   = document.getElementById('btnLimpiarLlegadas');
    const btnCerrarArr    = document.getElementById('btnCerrarLlegadas');
    const btnAplicarArr   = document.getElementById('btnAplicarLlegadas');

    const countInsideArr  = document.getElementById('countLlegadasInside');
    const filterLlegadas  = document.getElementById('filterLlegadas');
    const btnCopyLlegadas = document.getElementById('btnCopyLlegadas');

    const llegadasSet     = new Set(); // edici√≥n en modal
    const llegadasApplied = new Set(); // aplicado en tabla

    function parseListaArr(str){
      if(!str) return [];
      return str
        .split(/[^\d]+/g)
        .map(s => s.trim())
        .filter(Boolean)
        .filter(s => /^\d{4}$/.test(s));
    }

    function renderChipsLlegadas(filterText = ''){
      if (!chipsLlegadas) return;
      chipsLlegadas.innerHTML = '';
      const arr = Array.from(llegadasSet).sort();
      const f = (filterText || '').trim();
      let validCount = 0; let invalidCount = 0;
      for(const num of arr){
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        const isValid = roomCellMap.has(num);
        chip.className = 'chip ' + (isValid ? 'arr-valid' : 'arr-invalid');
        if (isValid) validCount++; else invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          llegadasSet.delete(num);
          renderChipsLlegadas(filterLlegadas?.value || '');
        });
        chipsLlegadas.appendChild(chip);
      }
      if (countInsideArr) countInsideArr.textContent = String(llegadasSet.size) + (invalidCount ? ` (inv√°lidas: ${invalidCount})` : '');
      const badge = document.getElementById('llegadasBadge');
      if (badge) badge.textContent = '(' + llegadasApplied.size + ')';
    }

    function abrirModalLlegadas(){
      llegadasSet.clear();
      llegadasApplied.forEach(v => llegadasSet.add(v));
      renderChipsLlegadas();
      if (inputLlegadas) inputLlegadas.value = '';
      if (modalLlegadas) modalLlegadas.hidden = false;
      setTimeout(()=>{ inputLlegadas?.focus(); }, 60);
    }
    function cerrarModalLlegadas(){ if (modalLlegadas) modalLlegadas.hidden = true; }

    function aplicarLlegadasEnTabla(){
      // quitar marcas anteriores
      llegadasApplied.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) td.classList.remove('estado-llegada');
      });
      llegadasApplied.clear();
      // aplicar de set
      llegadasSet.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) {
          td.classList.add('estado-llegada');
          llegadasApplied.add(num);
        }
      });
      if (countLlegadas) countLlegadas.textContent = '(' + llegadasApplied.size + ')';
      const badge = document.getElementById('llegadasBadge');
      if (badge) badge.textContent = '(' + llegadasApplied.size + ')';
    
      recalcOcupacion();
    }

    // Abrir modal
    btnLlegadas?.addEventListener('click', abrirModalLlegadas);

    // Limpiar todas
    btnLimpiarArr?.addEventListener('click', ()=>{
      llegadasSet.clear();
      renderChipsLlegadas(filterLlegadas?.value || '');
    });

    // Cerrar modal
    btnCerrarArr?.addEventListener('click', cerrarModalLlegadas);
    modalLlegadas?.addEventListener('click', (e)=>{ if (e.target === modalLlegadas) cerrarModalLlegadas(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modalLlegadas.hidden) cerrarModalLlegadas(); });

    // Aplicar (no cierra)
    btnAplicarArr?.addEventListener('click', ()=>{
      const modeEl = document.querySelector('input[name="modeArr"]:checked');
      const mode = modeEl ? modeEl.value : 'add';
      const arr = parseListaArr(inputLlegadas?.value || '');

      if (mode === 'add'){
        arr.forEach(n => llegadasSet.add(n));
      } else if (mode === 'remove'){
        arr.forEach(n => llegadasSet.delete(n));
      }
      renderChipsLlegadas(filterLlegadas?.value || '');
      if (inputLlegadas) inputLlegadas.value = '';
      aplicarLlegadasEnTabla();
    });

    // Filtro chips
    filterLlegadas?.addEventListener('input', (e)=>{
      renderChipsLlegadas(e.target.value || '');
    });

    // Copiar lista
    btnCopyLlegadas?.addEventListener('click', ()=>{
      const list = Array.from(llegadasSet).sort().join(', ');
      navigator.clipboard.writeText(list).catch(()=>{});
    });

    // Atajos de teclado
    inputLlegadas?.addEventListener('keydown', (e)=>{
      const val = inputLlegadas.value.trim();
      if ((e.key === 'Backspace' || e.key === 'Delete') && val === ''){
        const last = Array.from(llegadasSet).sort().pop();
        if (last){
          llegadasSet.delete(last);
          renderChipsLlegadas(filterLlegadas?.value || '');
          e.preventDefault();
        }
      } else if (e.key === 'Enter'){
        if (e.ctrlKey || !e.shiftKey){
          e.preventDefault();
          btnAplicarArr?.click();
        }
      }
    });


    // ====== Gesti√≥n de OCUPADAS (rosa) ======
    const btnOcupadas     = document.getElementById('btnOcupadas');
    const modalOcupadas   = document.getElementById('modalOcupadas');
    const inputOcupadas   = document.getElementById('inputOcupadas');
    const chipsOcupadas   = document.getElementById('chipsOcupadas');
    const countOcupadas   = document.getElementById('countOcupadas');

    const btnLimpiarOcc   = document.getElementById('btnLimpiarOcupadas');
    const btnCerrarOcc    = document.getElementById('btnCerrarOcupadas');
    const btnAplicarOcc   = document.getElementById('btnAplicarOcupadas');

    const countInsideOcc  = document.getElementById('countOcupadasInside');
    const filterOcupadas  = document.getElementById('filterOcupadas');
    const btnCopyOcupadas = document.getElementById('btnCopyOcupadas');

    const ocupadasSet     = new Set(); // edici√≥n en modal
    const ocupadasApplied = new Set(); // aplicado en tabla

    function parseListaOcc(str){
      if(!str) return [];
      return str
        .split(/[^\d]+/g)
        .map(s => s.trim())
        .filter(Boolean)
        .filter(s => /^\d{4}$/.test(s));
    }

    function renderChipsOcupadas(filterText = ''){
      if (!chipsOcupadas) return;
      chipsOcupadas.innerHTML = '';
      const arr = Array.from(ocupadasSet).sort();
      const f = (filterText || '').trim();
      let validCount = 0; let invalidCount = 0;
      for(const num of arr){
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        const isValid = roomCellMap.has(num);
        chip.className = 'chip ' + (isValid ? 'occ-valid' : 'occ-invalid');
        if (isValid) validCount++; else invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          ocupadasSet.delete(num);
          renderChipsOcupadas(filterOcupadas?.value || '');
        });
        chipsOcupadas.appendChild(chip);
      }
      if (countInsideOcc) countInsideOcc.textContent = String(ocupadasSet.size) + (invalidCount ? ` (inv√°lidas: ${invalidCount})` : '');
      const badge = document.getElementById('ocupadasBadge');
      if (badge) badge.textContent = '(' + ocupadasApplied.size + ')';
    }

    function abrirModalOcupadas(){
      ocupadasSet.clear();
      ocupadasApplied.forEach(v => ocupadasSet.add(v));
      renderChipsOcupadas();
      if (inputOcupadas) inputOcupadas.value = '';
      if (modalOcupadas) modalOcupadas.hidden = false;
      setTimeout(()=>{ inputOcupadas?.focus(); }, 60);
    }
    function cerrarModalOcupadas(){ if (modalOcupadas) modalOcupadas.hidden = true; }

    function aplicarOcupadasEnTabla(){
      // quitar marcas anteriores
      ocupadasApplied.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) td.classList.remove('estado-ocupada');
      });
      ocupadasApplied.clear();
      // aplicar de set
      ocupadasSet.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) {
          td.classList.add('estado-ocupada');
          ocupadasApplied.add(num);
        }
      });
      if (countOcupadas) countOcupadas.textContent = '(' + ocupadasApplied.size + ')';
      const badge = document.getElementById('ocupadasBadge');
      if (badge) badge.textContent = '(' + ocupadasApplied.size + ')';
    
      recalcOcupacion();
    }

    // Abrir modal
    btnOcupadas?.addEventListener('click', abrirModalOcupadas);

    // Limpiar todas
    btnLimpiarOcc?.addEventListener('click', ()=>{
      ocupadasSet.clear();
      renderChipsOcupadas(filterOcupadas?.value || '');
    });

    // Cerrar modal
    btnCerrarOcc?.addEventListener('click', cerrarModalOcupadas);
    modalOcupadas?.addEventListener('click', (e)=>{ if (e.target === modalOcupadas) cerrarModalOcupadas(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modalOcupadas.hidden) cerrarModalOcupadas(); });

    // Aplicar (no cierra)
    btnAplicarOcc?.addEventListener('click', ()=>{
      const modeEl = document.querySelector('input[name="modeOcc"]:checked');
      const mode = modeEl ? modeEl.value : 'add';
      const arr = parseListaOcc(inputOcupadas?.value || '');

      if (mode === 'add'){
        arr.forEach(n => ocupadasSet.add(n));
      } else if (mode === 'remove'){
        arr.forEach(n => ocupadasSet.delete(n));
      }
      renderChipsOcupadas(filterOcupadas?.value || '');
      if (inputOcupadas) inputOcupadas.value = '';
      aplicarOcupadasEnTabla();
    });

    // Filtro chips
    filterOcupadas?.addEventListener('input', (e)=>{
      renderChipsOcupadas(e.target.value || '');
    });

    // Copiar lista
    btnCopyOcupadas?.addEventListener('click', ()=>{
      const list = Array.from(ocupadasSet).sort().join(', ');
      navigator.clipboard.writeText(list).catch(()=>{});
    });

    // Atajos de teclado
    inputOcupadas?.addEventListener('keydown', (e)=>{
      const val = inputOcupadas.value.trim();
      if ((e.key === 'Backspace' || e.key === 'Delete') && val === ''){
        const last = Array.from(ocupadasSet).sort().pop();
        if (last){
          ocupadasSet.delete(last);
          renderChipsOcupadas(filterOcupadas?.value || '');
          e.preventDefault();
        }
      } else if (e.key === 'Enter'){
        if (e.ctrlKey || !e.shiftKey){
          e.preventDefault();
          btnAplicarOcc?.click();
        }
      }
    });


    // ====== Gesti√≥n de FUERA DE SERVICIO (naranja/rojo) ======
    const btnFuera       = document.getElementById('btnFuera');
    const modalFuera     = document.getElementById('modalFuera');
    const inputFuera     = document.getElementById('inputFuera');
    const chipsFuera     = document.getElementById('chipsFuera');
    const countFuera     = document.getElementById('countFuera');

    const btnLimpiarOut  = document.getElementById('btnLimpiarFuera');
    const btnCerrarOut   = document.getElementById('btnCerrarFuera');
    const btnAplicarOut  = document.getElementById('btnAplicarFuera');

    const countInsideOut = document.getElementById('countFueraInside');
    const filterFuera    = document.getElementById('filterFuera');
    const btnCopyFuera   = document.getElementById('btnCopyFuera');

    const fueraSet       = new Set(); // edici√≥n en modal
    const fueraApplied   = new Set(); // aplicado en tabla

    function parseListaOut(str){
      if(!str) return [];
      return str
        .split(/[^\d]+/g)
        .map(s => s.trim())
        .filter(Boolean)
        .filter(s => /^\d{4}$/.test(s));
    }

    function renderChipsFuera(filterText = ''){
      if (!chipsFuera) return;
      chipsFuera.innerHTML = '';
      const arr = Array.from(fueraSet).sort();
      const f = (filterText || '').trim();
      let validCount = 0; let invalidCount = 0;
      for(const num of arr){
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        const isValid = roomCellMap.has(num);
        chip.className = 'chip ' + (isValid ? 'out-valid' : 'out-invalid');
        if (isValid) validCount++; else invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          fueraSet.delete(num);
          renderChipsFuera(filterFuera?.value || '');
        });
        chipsFuera.appendChild(chip);
      }
      if (countInsideOut) countInsideOut.textContent = String(fueraSet.size) + (invalidCount ? ` (inv√°lidas: ${invalidCount})` : '');
      const badge = document.getElementById('fueraBadge');
      if (badge) badge.textContent = '(' + fueraApplied.size + ')';
    }

    function abrirModalFuera(){
      fueraSet.clear();
      fueraApplied.forEach(v => fueraSet.add(v));
      renderChipsFuera();
      if (inputFuera) inputFuera.value = '';
      if (modalFuera) modalFuera.hidden = false;
      setTimeout(()=>{ inputFuera?.focus(); }, 60);
    }
    function cerrarModalFuera(){ if (modalFuera) modalFuera.hidden = true; }

    function aplicarFueraEnTabla(){
      // quitar marcas anteriores
      fueraApplied.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) td.classList.remove('estado-fuera');
      });
      fueraApplied.clear();
      // aplicar de set
      fueraSet.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) {
          td.classList.add('estado-fuera');
          fueraApplied.add(num);
        }
      });
      if (countFuera) countFuera.textContent = '(' + fueraApplied.size + ')';
      const badge = document.getElementById('fueraBadge');
      if (badge) badge.textContent = '(' + fueraApplied.size + ')';
    
      recalcOcupacion();
    }

    // Abrir modal
    btnFuera?.addEventListener('click', abrirModalFuera);

    // Limpiar todas
    btnLimpiarOut?.addEventListener('click', ()=>{
      fueraSet.clear();
      renderChipsFuera(filterFuera?.value || '');
    });

    // Cerrar modal
    btnCerrarOut?.addEventListener('click', cerrarModalFuera);
    modalFuera?.addEventListener('click', (e)=>{ if (e.target === modalFuera) cerrarModalFuera(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modalFuera.hidden) cerrarModalFuera(); });

    // Aplicar (no cierra)
    btnAplicarOut?.addEventListener('click', ()=>{
      const modeEl = document.querySelector('input[name="modeOut"]:checked');
      const mode = modeEl ? modeEl.value : 'add';
      const arr = parseListaOut(inputFuera?.value || '');

      if (mode === 'add'){
        arr.forEach(n => fueraSet.add(n));
      } else if (mode === 'remove'){
        arr.forEach(n => fueraSet.delete(n));
      }
      renderChipsFuera(filterFuera?.value || '');
      if (inputFuera) inputFuera.value = '';
      aplicarFueraEnTabla();
    });

    // Filtro chips
    filterFuera?.addEventListener('input', (e)=>{
      renderChipsFuera(e.target.value || '');
    });

    // Copiar lista
    btnCopyFuera?.addEventListener('click', ()=>{
      const list = Array.from(fueraSet).sort().join(', ');
      navigator.clipboard.writeText(list).catch(()=>{});
    });

    // Atajos de teclado
    inputFuera?.addEventListener('keydown', (e)=>{
      const val = inputFuera.value.trim();
      if ((e.key === 'Backspace' || e.key === 'Delete') && val === ''){
        const last = Array.from(fueraSet).sort().pop();
        if (last){
          fueraSet.delete(last);
          renderChipsFuera(filterFuera?.value || '');
          e.preventDefault();
        }
      } else if (e.key === 'Enter'){
        if (e.ctrlKey || !e.shiftKey){
          e.preventDefault();
          btnAplicarOut?.click();
        }
      }
    });


    // ====== Gesti√≥n de SHOW ROOM (verde) ======
    const btnShowroom     = document.getElementById('btnShowroom');
    const modalShowroom   = document.getElementById('modalShowroom');
    const inputShowroom   = document.getElementById('inputShowroom');
    const chipsShowroom   = document.getElementById('chipsShowroom');
    const countShowroom   = document.getElementById('countShowroom');

    const btnLimpiarShow  = document.getElementById('btnLimpiarShowroom');
    const btnCerrarShow   = document.getElementById('btnCerrarShowroom');
    const btnAplicarShow  = document.getElementById('btnAplicarShowroom');

    const countInsideShow = document.getElementById('countShowroomInside');
    const filterShowroom  = document.getElementById('filterShowroom');
    const btnCopyShowroom = document.getElementById('btnCopyShowroom');

    const showroomSet     = new Set(); // edici√≥n en modal
    const showroomApplied = new Set(); // aplicado en tabla

    function parseListaShow(str){
      if(!str) return [];
      return str
        .split(/[^\d]+/g)
        .map(s => s.trim())
        .filter(Boolean)
        .filter(s => /^\d{4}$/.test(s));
    }

    function renderChipsShowroom(filterText = ''){
      if (!chipsShowroom) return;
      chipsShowroom.innerHTML = '';
      const arr = Array.from(showroomSet).sort();
      const f = (filterText || '').trim();
      let validCount = 0; let invalidCount = 0;
      for(const num of arr){
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        const isValid = roomCellMap.has(num);
        chip.className = 'chip ' + (isValid ? 'show-valid' : 'show-invalid');
        if (isValid) validCount++; else invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          showroomSet.delete(num);
          renderChipsShowroom(filterShowroom?.value || '');
        });
        chipsShowroom.appendChild(chip);
      }
      if (countInsideShow) countInsideShow.textContent = String(showroomSet.size) + (invalidCount ? ` (inv√°lidas: ${invalidCount})` : '');
      const badge = document.getElementById('showroomBadge');
      if (badge) badge.textContent = '(' + showroomApplied.size + ')';
    }

    function abrirModalShowroom(){
      showroomSet.clear();
      showroomApplied.forEach(v => showroomSet.add(v));
      renderChipsShowroom();
      if (inputShowroom) inputShowroom.value = '';
      if (modalShowroom) modalShowroom.hidden = false;
      setTimeout(()=>{ inputShowroom?.focus(); }, 60);
    }
    function cerrarModalShowroom(){ if (modalShowroom) modalShowroom.hidden = true; }

    function aplicarShowroomEnTabla(){
      showroomApplied.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) td.classList.remove('estado-showroom');
      });
      showroomApplied.clear();
      showroomSet.forEach(num => {
        const td = roomCellMap.get(num);
        if (td) {
          td.classList.add('estado-showroom');
          showroomApplied.add(num);
        }
      });
      if (countShowroom) countShowroom.textContent = '(' + showroomApplied.size + ')';
      const badge = document.getElementById('showroomBadge');
      if (badge) badge.textContent = '(' + showroomApplied.size + ')';
    
      recalcOcupacion();
    }

    // Abrir modal
    btnShowroom?.addEventListener('click', abrirModalShowroom);

    // Limpiar todas
    btnLimpiarShow?.addEventListener('click', ()=>{
      showroomSet.clear();
      renderChipsShowroom(filterShowroom?.value || '');
    });

    // Cerrar modal
    btnCerrarShow?.addEventListener('click', cerrarModalShowroom);
    modalShowroom?.addEventListener('click', (e)=>{ if (e.target === modalShowroom) cerrarModalShowroom(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modalShowroom.hidden) cerrarModalShowroom(); });

    // Aplicar (no cierra)
    btnAplicarShow?.addEventListener('click', ()=>{
      const modeEl = document.querySelector('input[name="modeShow"]:checked');
      const mode = modeEl ? modeEl.value : 'add';
      const arr = parseListaShow(inputShowroom?.value || '');

      if (mode === 'add'){
        arr.forEach(n => showroomSet.add(n));
      } else if (mode === 'remove'){
        arr.forEach(n => showroomSet.delete(n));
      }
      renderChipsShowroom(filterShowroom?.value || '');
      if (inputShowroom) inputShowroom.value = '';
      aplicarShowroomEnTabla();
    });

    // Filtro chips
    filterShowroom?.addEventListener('input', (e)=>{
      renderChipsShowroom(e.target.value || '');
    });

    // Copiar lista
    btnCopyShowroom?.addEventListener('click', ()=>{
      const list = Array.from(showroomSet).sort().join(', ');
      navigator.clipboard.writeText(list).catch(()=>{});
    });

    // Atajos de teclado
    inputShowroom?.addEventListener('keydown', (e)=>{
      const val = inputShowroom.value.trim();
      if ((e.key === 'Backspace' || e.key === 'Delete') && val === ''){
        const last = Array.from(showroomSet).sort().pop();
        if (last){
          showroomSet.delete(last);
          renderChipsShowroom(filterShowroom?.value || '');
          e.preventDefault();
        }
      } else if (e.key === 'Enter'){
        if (e.ctrlKey || !e.shiftKey){
          e.preventDefault();
          btnAplicarShow?.click();
        }
      }
    });


    // ====== C√°lculo de % Ocupaci√≥n (proyecci√≥n) ======
    function recalcOcupacion(){
      try{
        const occBase   = (typeof ocupadasApplied !== 'undefined' && ocupadasApplied && typeof ocupadasApplied.size === 'number') ? ocupadasApplied.size : 0;
        const arrivals  = (typeof llegadasApplied !== 'undefined' && llegadasApplied && typeof llegadasApplied.size === 'number') ? llegadasApplied.size : 0;
        const departures= (typeof salidasApplied  !== 'undefined' && salidasApplied  && typeof salidasApplied.size  === 'number') ? salidasApplied.size  : 0;

        let projectedOcc = occBase + arrivals - departures;
        projectedOcc = Math.max(0, Math.min(TOTAL_ROOMS, projectedOcc));

        const pct = TOTAL_ROOMS > 0 ? Math.round((projectedOcc / TOTAL_ROOMS) * 100) : 0;

        const v = document.getElementById('vOcup');
        if (v) v.textContent = pct + '%';

        const pill = document.getElementById('mOcup');
        if (pill){
          pill.classList.remove('is-low','is-mid','is-high');
          if (pct < 60)      pill.classList.add('is-low');
          else if (pct < 85) pill.classList.add('is-mid');
          else               pill.classList.add('is-high');
        }
      }catch(e){ /* silent */ }
    }
    // Calcular al inicio
    recalcOcupacion();


    // ===== NPS: Local history + chart =====
    const NPS_KEY = 'sabanaNpsV1';
    const mNpsBtn = document.getElementById('mNps');
    const vNps    = document.getElementById('vNps');
    const modalNps= document.getElementById('modalNps');
    const npsInput= document.getElementById('npsValueInput');
    const npsNote = document.getElementById('npsNote');
    const npsBadge= document.getElementById('npsBadge');
    const npsFrom = document.getElementById('npsFrom');
    const npsTo   = document.getElementById('npsTo');
    const npsCanvas = document.getElementById('npsCanvas');
    const btnGuardarNps = document.getElementById('btnGuardarNps');

    function fmtDateKey(d){
      const f = new Intl.DateTimeFormat('en-CA',{ timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' });
      return f.format(d);
    }
    function fmtTimeStr(d){
      const f = new Intl.DateTimeFormat('es-MX',{ timeZone: tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
      return f.format(d);
    }
    function getNpsHist(){
      try{ return JSON.parse(localStorage.getItem(NPS_KEY) || '[]'); } catch{ return []; }
    }
    function setNpsHist(arr){
      try{ localStorage.setItem(NPS_KEY, JSON.stringify(arr)); }catch{}
    }
    function upsertTodayNps(value, note=''){
      const today = fmtDateKey(new Date());
      const hist = getNpsHist();
      const idx = hist.findIndex(x => x.dateKey === today);
      const item = { dateKey: today, value: Number(value), note: (note||'').trim(), savedAt: today + ' ' + fmtTimeStr(new Date()) };
      if (idx >= 0) hist[idx] = item; else hist.push(item);
      setNpsHist(hist);
      return item;
    }
    function latestNpsValue(){
      const hist = getNpsHist().sort((a,b)=> a.dateKey===b.dateKey ? (a.savedAt>b.savedAt?1:-1) : (a.dateKey>b.dateKey?1:-1));
      return hist.length ? hist[hist.length-1].value : null;
    }

    function openNpsModal(){
      if (!modalNps) return;
      modalNps.hidden = false;
      const today = fmtDateKey(new Date());
      // preset filter to last 30 days
      const d = new Date(); const to = fmtDateKey(d);
      d.setDate(d.getDate()-30); const from = fmtDateKey(d);
      if (npsFrom) npsFrom.value = from;
      if (npsTo)   npsTo.value   = to;
      drawNpsChart();
      setTimeout(()=>{ npsInput?.focus(); }, 80);
    }
    function closeNpsModal(){ if (modalNps) modalNps.hidden = true; }

    function drawNpsChart(){
      if (!npsCanvas) return;
      const ctx = npsCanvas.getContext('2d');
      // clear
      ctx.clearRect(0,0,npsCanvas.width,npsCanvas.height);
      const W = npsCanvas.width, H = npsCanvas.height;
      const pad = {l:40,r:10,t:10,b:20};

      // get data filtered
      const all = getNpsHist().sort((a,b)=> a.dateKey < b.dateKey ? -1 : (a.dateKey>b.dateKey?1:0));
      const from = npsFrom?.value || '';
      const to   = npsTo?.value || '';
      const data = all.filter(x => (!from || x.dateKey >= from) && (!to || x.dateKey <= to));

      // axes
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      for (let y=-100; y<=100; y+=20){
        const py = pad.t + (H-pad.t-pad.b) * (1 - (y+100)/200);
        ctx.beginPath(); ctx.moveTo(pad.l, py); ctx.lineTo(W-pad.r, py); ctx.stroke();
        if (y%40===0){
          ctx.fillStyle = '#6b7280';
          ctx.font = '10px system-ui';
          ctx.fillText(String(y), 4, py+3);
        }
      }

      // series
      if (data.length === 0){
        ctx.fillStyle = '#6b7280'; ctx.font = '12px system-ui';
        ctx.fillText('Sin datos para el rango seleccionado', pad.l+10, H/2);
        return;
      }

      const n = data.length;
      const step = (W - pad.l - pad.r) / Math.max(1, n-1);
      ctx.lineWidth = 2; ctx.strokeStyle = '#0EA5E9';
      ctx.beginPath();
      for (let i=0; i<n; i++){
        const x = pad.l + i*step;
        const val = Math.max(-100, Math.min(100, Number(data[i].value)||0));
        const y = pad.t + (H-pad.t-pad.b) * (1 - (val+100)/200);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // points
      ctx.fillStyle = '#0EA5E9';
      for (let i=0; i<n; i++){
        const x = pad.l + i*step;
        const val = Math.max(-100, Math.min(100, Number(data[i].value)||0));
        const y = pad.t + (H-pad.t-pad.b) * (1 - (val+100)/200);
        ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      }
    }

    // Event wiring
    mNpsBtn?.addEventListener('click', openNpsModal);
    document.getElementById('btnCerrarNps')?.addEventListener('click', closeNpsModal);
    modalNps?.addEventListener('click', (e)=>{ if (e.target === modalNps) closeNpsModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && !modalNps?.hidden) closeNpsModal(); });

    // Quick range buttons
    document.querySelectorAll('.nps-quick .btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = btn.getAttribute('data-range');
        const to = new Date();
        let from = new Date();
        if (v === 'all'){ npsFrom.value = ''; npsTo.value = ''; }
        else{
          const days = Number(v)||30;
          from.setDate(to.getDate()-days);
          // set date inputs
          npsFrom.value = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(from);
          npsTo.value   = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(to);
        }
        drawNpsChart();
      });
    });
    document.getElementById('btnNpsFiltrar')?.addEventListener('click', drawNpsChart);
    npsFrom?.addEventListener('change', drawNpsChart);
    npsTo?.addEventListener('change', drawNpsChart);

    // Guardar NPS de hoy
    btnGuardarNps?.addEventListener('click', ()=>{
      const val = Number(npsInput?.value);
      if (Number.isNaN(val) || val < -100 || val > 100){
        alert('Ingresa un NPS entre -100 y 100'); return;
      }
      const snap = upsertTodayNps(val, npsNote?.value || '');
      // UI indicators
      if (vNps) vNps.textContent = (val>0? '+' : '') + String(val);
      if (npsBadge) npsBadge.textContent = (val>0? '+' : '') + String(val);
      drawNpsChart();
      // limpiar input nota
      if (npsNote) npsNote.value = '';
    });

    // Al cargar: mostrar √∫ltimo NPS guardado (si existe)
    (function initNps(){
      const last = latestNpsValue();
      if (last !== null){
        if (vNps) vNps.textContent = (last>0? '+' : '') + String(last);
        if (npsBadge) npsBadge.textContent = (last>0? '+' : '') + String(last);
      } else {
        if (vNps) vNps.textContent = '--';
        if (npsBadge) npsBadge.textContent = '--';
      }
    })();


    // ===== IP Room =====
    const mIp              = document.getElementById('mIp');
    const vIp              = document.getElementById('vIp');
    const modalIpRoom      = document.getElementById('modalIpRoom');
    const inputIpRoom      = document.getElementById('inputIpRoom');
    const chipsIpRoom      = document.getElementById('chipsIpRoom');
    const filterIpRoom     = document.getElementById('filterIpRoom');
    const countIpRoomInside= document.getElementById('countIpRoomInside');
    const btnCopyIpRoom    = document.getElementById('btnCopyIpRoom');
    const btnLimpiarIpRoom = document.getElementById('btnLimpiarIpRoom');
    const btnCerrarIpRoom  = document.getElementById('btnCerrarIpRoom');
    const btnAplicarIpRoom = document.getElementById('btnAplicarIpRoom');
    const ipRoomBadge      = document.getElementById('ipRoomBadge');

    // Mapa de habitaciones (usa el global si existe; si no, lo construye)
    let roomCellMapLocal = (typeof roomCellMap !== 'undefined' && roomCellMap instanceof Map) ? roomCellMap : null;
    if (!roomCellMapLocal){
      roomCellMapLocal = new Map();
      document.querySelectorAll('table.excel tbody td').forEach(td => {
        const txt = (td.textContent || '').trim();
        if (/^\d{4}$/.test(txt)) roomCellMapLocal.set(txt, td);
      });
      // no sobrescribimos el global si ya exist√≠a
    }

    // Estados IP Room
    const ipRoomApplied = new Set(); // aplicado
    let   ipRoomEdit    = new Set(); // edici√≥n (modal)

    function tokenizeIpRoom(str){
      if (!str) return [];
      return str.split(/[^\d]+/g).map(s=>s.trim()).filter(Boolean);
    }
    function toValidIpSet(arr){
      const out = new Set();
      for (const raw of arr){
        const n = raw.padStart(4,'0'); // tolera 3 d√≠gitos como 0xxx
        if (/^\d{4}$/.test(n) && roomCellMapLocal.has(n)) out.add(n);
      }
      return out;
    }

    function renderChipsIpRoom(filterText=''){
      if (!chipsIpRoom) return;
      chipsIpRoom.innerHTML = '';
      const f = (filterText||'').trim();
      let invalidCount = 0;
      const all = [...ipRoomEdit].sort((a,b)=> a.localeCompare(b));
      for (const num of all){
        const valid = roomCellMapLocal.has(num);
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        chip.className = 'chip ' + (valid ? 'occ-valid' : 'occ-invalid');
        if (!valid) invalidCount++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          ipRoomEdit.delete(num);
          renderChipsIpRoom(filterIpRoom?.value || '');
          if (countIpRoomInside) countIpRoomInside.textContent = String(ipRoomEdit.size);
        });
        chipsIpRoom.appendChild(chip);
      }
      if (countIpRoomInside) countIpRoomInside.textContent = String(ipRoomEdit.size) + (invalidCount?` (inv√°lidas: ${invalidCount})`:'');
    }

    function abrirModalIpRoom(){
      ipRoomEdit = new Set(ipRoomApplied); // clona lo aplicado
      if (inputIpRoom) inputIpRoom.value = [...ipRoomEdit].join(', ');
      renderChipsIpRoom();
      if (ipRoomBadge) ipRoomBadge.textContent = `(${ipRoomApplied.size})`;
      if (modalIpRoom) modalIpRoom.hidden = false;
    }
    function cerrarModalIpRoom(){ if (modalIpRoom) modalIpRoom.hidden = true; }

    // Eventos del modal
    mIp?.addEventListener('click', abrirModalIpRoom);
    btnCerrarIpRoom?.addEventListener('click', cerrarModalIpRoom);
    modalIpRoom?.addEventListener('click', (e)=>{ if (e.target === modalIpRoom) cerrarModalIpRoom(); });

    inputIpRoom?.addEventListener('input', ()=>{
      const tokens = tokenizeIpRoom(inputIpRoom.value);
      ipRoomEdit = toValidIpSet(tokens);
      renderChipsIpRoom(filterIpRoom?.value || '');
    });
    filterIpRoom?.addEventListener('input', ()=> renderChipsIpRoom(filterIpRoom.value || ''));
    btnCopyIpRoom?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText([...ipRoomEdit].join(', ')); }catch{}
    });
    btnLimpiarIpRoom?.addEventListener('click', ()=>{
      ipRoomEdit.clear();
      renderChipsIpRoom(filterIpRoom?.value || '');
      if (inputIpRoom) inputIpRoom.value='';
    });

    function aplicarIpRoomEnTabla(){
      // Quitar estado previo
      ipRoomApplied.forEach(num => {
        const td = roomCellMapLocal.get(num);
        if (td){ td.classList.remove('estado-iproom'); }
      });
      ipRoomApplied.clear();

      // Aplicar nuevos
      ipRoomEdit.forEach(num => {
        const td = roomCellMapLocal.get(num);
        if (td){
          td.classList.add('estado-iproom'); // ‚úÖ a la izquierda
          ipRoomApplied.add(num);
        }
      });

      // Actualiza contadores visuales
      if (vIp)       vIp.textContent       = String(ipRoomApplied.size || 0);
      if (ipRoomBadge) ipRoomBadge.textContent = `(${ipRoomApplied.size})`;
    }
    btnAplicarIpRoom?.addEventListener('click', aplicarIpRoomEnTabla);

    // Inicializa contador si viene vac√≠o
    if (vIp && !vIp.textContent.trim()) vIp.textContent = '0';


    // ===== Strobe global para celdas Salida+Llegada (sincronizado) =====
    (function(){
      try{
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (!prefersReduced){
          const root = document.documentElement;
          // Asegura una fase inicial estable
          root.classList.remove('strobeB');
          setInterval(()=> root.classList.toggle('strobeB'), 900); // 0.9s alternado
        }
      }catch{}
    })();


    // === Llegadas Expedia (usa pill existente mExpedia / vExpedia) ===
    const mExpedia            = document.getElementById('mExpedia');
    const vExpedia            = document.getElementById('vExpedia');
    const modalExpedia        = document.getElementById('modalExpedia');
    const listExpedia         = document.getElementById('listExpedia');
    const chipsExpedia        = document.getElementById('chipsExpedia');
    const filterExpedia       = document.getElementById('filterExpedia');
    const countExpediaInside  = document.getElementById('countExpediaInside');
    const btnPasteExpedia     = document.getElementById('btnPasteExpedia');
    const btnCopyExpedia      = document.getElementById('btnCopyExpedia');
    const btnLimpiarExpedia   = document.getElementById('btnLimpiarExpedia');
    const btnCerrarExpedia    = document.getElementById('btnCerrarExpedia');
    const btnAplicarExpedia   = document.getElementById('btnAplicarExpedia');
    const expediaBadge        = document.getElementById('expediaBadge');

    const roomMapExp          = (typeof roomCellMap!=='undefined') ? roomCellMap : new Map();
    const expediaApplied      = new Set(); // rooms con marca-expedia
    let   expediaEdit         = new Set();

    function tokenizeRooms(str){
      if (!str) return [];
      return str.split(/[^\d]+/g).map(s=>s.trim()).filter(Boolean);
    }
    function toValidRooms(arr){
      const out = new Set();
      for (const raw of arr){
        const n = raw.replace(/^0+/, '').padStart(4,'0');
        if (/^\d{4}$/.test(n) && roomMapExp.has(n)) out.add(n);
      }
      return out;
    }
    function renderChipsExpedia(filterText=''){
      if (!chipsExpedia) return;
      chipsExpedia.innerHTML='';
      const f = (filterText||'').trim();
      let invalid = 0;
      for (const num of Array.from(expediaEdit).sort()){
        const valid = roomMapExp.has(num);
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        chip.className = 'chip ' + (valid ? 'occ-valid' : 'occ-invalid');
        if (!valid) invalid++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          expediaEdit.delete(num);
          renderChipsExpedia(filterExpedia?.value||'');
          if (countExpediaInside) countExpediaInside.textContent = String(expediaEdit.size);
        });
        chipsExpedia.appendChild(chip);
      }
      if (countExpediaInside) countExpediaInside.textContent = String(expediaEdit.size) + (invalid?` (inv√°lidas: ${invalid})`:'');
    }

    function abrirModalExpedia(){
      expediaEdit.clear();
      expediaApplied.forEach(n=> expediaEdit.add(n));
      if (listExpedia) listExpedia.value = Array.from(expediaEdit).join(', ');
      renderChipsExpedia();
      if (expediaBadge) expediaBadge.textContent = `(${expediaApplied.size})`;
      if (modalExpedia) modalExpedia.hidden = false;
    }
    function cerrarModalExpedia(){ if (modalExpedia) modalExpedia.hidden = true; }

    mExpedia?.addEventListener('click', abrirModalExpedia);
    btnCerrarExpedia?.addEventListener('click', cerrarModalExpedia);
    modalExpedia?.addEventListener('click', (e)=>{ if (e.target===modalExpedia) cerrarModalExpedia(); });

    btnPasteExpedia?.addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if (listExpedia) listExpedia.value = t;
        expediaEdit = toValidRooms(tokenizeRooms(t));
        renderChipsExpedia(filterExpedia?.value||'');
      }catch{}
    });
    btnCopyExpedia?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(Array.from(expediaEdit).join(', ')); }catch{} });
    btnLimpiarExpedia?.addEventListener('click', ()=>{
      expediaEdit.clear();
      renderChipsExpedia(filterExpedia?.value||'');
      if (listExpedia) listExpedia.value='';
    });
    filterExpedia?.addEventListener('input', ()=> renderChipsExpedia(filterExpedia.value||''));
    listExpedia?.addEventListener('input', ()=>{
      expediaEdit = toValidRooms(tokenizeRooms(listExpedia.value));
      renderChipsExpedia(filterExpedia?.value||'');
    });

    function aplicarExpediaEnTabla(){
      // Quitar marca-expedia a los anteriores (sin quitar estado-llegada)
      expediaApplied.forEach(num=>{
        const td = roomMapExp.get(num);
        if (td) td.classList.remove('marca-expedia');
      });
      expediaApplied.clear();

      // Aplicar nuevos: asegurar llegada y marcar expedia
      expediaEdit.forEach(num=>{
        const td = roomMapExp.get(num);
        if (td){
          td.classList.add('estado-llegada');
          td.classList.add('marca-expedia');
          expediaApplied.add(num);
        }
      });

      if (vExpedia)     vExpedia.textContent = String(expediaApplied.size||0);
      if (expediaBadge) expediaBadge.textContent = `(${expediaApplied.size||0})`;
    }
    btnAplicarExpedia?.addEventListener('click', aplicarExpediaEnTabla);

    // init value
    if (vExpedia && !vExpedia.textContent.trim()) vExpedia.textContent = '0';


    // === Llegadas Booking (usa pill existente mBooking / vBooking) ===
    const mBooking            = document.getElementById('mBooking');
    const vBooking            = document.getElementById('vBooking');
    const modalBooking        = document.getElementById('modalBooking');
    const listBooking         = document.getElementById('listBooking');
    const chipsBooking        = document.getElementById('chipsBooking');
    const filterBooking       = document.getElementById('filterBooking');
    const countBookingInside  = document.getElementById('countBookingInside');
    const btnPasteBooking     = document.getElementById('btnPasteBooking');
    const btnCopyBooking      = document.getElementById('btnCopyBooking');
    const btnLimpiarBooking   = document.getElementById('btnLimpiarBooking');
    const btnCerrarBooking    = document.getElementById('btnCerrarBooking');
    const btnAplicarBooking   = document.getElementById('btnAplicarBooking');
    const bookingBadge        = document.getElementById('bookingBadge');

    const roomMapBk           = (typeof roomCellMap!=='undefined') ? roomCellMap : new Map();
    const bookingApplied      = new Set(); // rooms con marca-booking
    let   bookingEdit         = new Set();

    function tokenizeRoomsBk(str){
      if (!str) return [];
      return str.split(/[^\d]+/g).map(s=>s.trim()).filter(Boolean);
    }
    function toValidRoomsBk(arr){
      const out = new Set();
      for (const raw of arr){
        const n = raw.replace(/^0+/, '').padStart(4,'0');
        if (/^\d{4}$/.test(n) && roomMapBk.has(n)) out.add(n);
      }
      return out;
    }
    function renderChipsBooking(filterText=''){
      if (!chipsBooking) return;
      chipsBooking.innerHTML='';
      const f = (filterText||'').trim();
      let invalid = 0;
      for (const num of Array.from(bookingEdit).sort()){
        const valid = roomMapBk.has(num);
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        chip.className = 'chip ' + (valid ? 'occ-valid' : 'occ-invalid');
        if (!valid) invalid++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          bookingEdit.delete(num);
          renderChipsBooking(filterBooking?.value||'');
          if (countBookingInside) countBookingInside.textContent = String(bookingEdit.size);
        });
        chipsBooking.appendChild(chip);
      }
      if (countBookingInside) countBookingInside.textContent = String(bookingEdit.size) + (invalid?` (inv√°lidas: ${invalid})`:'');
    }

    function abrirModalBooking(){
      bookingEdit.clear();
      bookingApplied.forEach(n=> bookingEdit.add(n));
      if (listBooking) listBooking.value = Array.from(bookingEdit).join(', ');
      renderChipsBooking();
      if (bookingBadge) bookingBadge.textContent = `(${bookingApplied.size})`;
      if (modalBooking) modalBooking.hidden = false;
    }
    function cerrarModalBooking(){ if (modalBooking) modalBooking.hidden = true; }

    mBooking?.addEventListener('click', abrirModalBooking);
    btnCerrarBooking?.addEventListener('click', cerrarModalBooking);
    modalBooking?.addEventListener('click', (e)=>{ if (e.target===modalBooking) cerrarModalBooking(); });

    btnPasteBooking?.addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if (listBooking) listBooking.value = t;
        bookingEdit = toValidRoomsBk(tokenizeRoomsBk(t));
        renderChipsBooking(filterBooking?.value||'');
      }catch{}
    });
    btnCopyBooking?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(Array.from(bookingEdit).join(', ')); }catch{} });
    btnLimpiarBooking?.addEventListener('click', ()=>{
      bookingEdit.clear();
      renderChipsBooking(filterBooking?.value||'');
      if (listBooking) listBooking.value='';
    });
    filterBooking?.addEventListener('input', ()=> renderChipsBooking(filterBooking.value||''));
    listBooking?.addEventListener('input', ()=>{
      bookingEdit = toValidRoomsBk(tokenizeRoomsBk(listBooking.value));
      renderChipsBooking(filterBooking?.value||'');
    });

    function aplicarBookingEnTabla(){
      // Quitar marca-booking a los anteriores (sin quitar estado-llegada)
      bookingApplied.forEach(num=>{
        const td = roomMapBk.get(num);
        if (td) td.classList.remove('marca-booking');
      });
      bookingApplied.clear();

      // Aplicar nuevos: asegurar llegada y marcar booking
      bookingEdit.forEach(num=>{
        const td = roomMapBk.get(num);
        if (td){
          td.classList.add('estado-llegada');
          td.classList.add('marca-booking');
          bookingApplied.add(num);
        }
      });

      if (vBooking)     vBooking.textContent = String(bookingApplied.size||0);
      if (bookingBadge) bookingBadge.textContent = `(${bookingApplied.size||0})`;
    }
    btnAplicarBooking?.addEventListener('click', aplicarBookingEnTabla);

    // init value
    if (vBooking && !vBooking.textContent.trim()) vBooking.textContent = '0';


    // === VIPs: usa el bot√≥n existente mVips / vVips ===
    const mVips            = document.getElementById('mVips');
    const vVips            = document.getElementById('vVips');
    const modalVips        = document.getElementById('modalVips');
    const listVips         = document.getElementById('listVips');
    const chipsVips        = document.getElementById('chipsVips');
    const filterVips       = document.getElementById('filterVips');
    const countVipsInside  = document.getElementById('countVipsInside');
    const btnPasteVips     = document.getElementById('btnPasteVips');
    const btnCopyVips      = document.getElementById('btnCopyVips');
    const btnLimpiarVips   = document.getElementById('btnLimpiarVips');
    const btnCerrarVips    = document.getElementById('btnCerrarVips');
    const btnAplicarVips   = document.getElementById('btnAplicarVips');
    const vipsBadge        = document.getElementById('vipsBadge');

    const roomMapVip       = (typeof roomCellMap!=='undefined') ? roomCellMap : new Map();
    const vipsApplied      = new Set();
    let   vipsEdit         = new Set();

    function tokenizeVips(str){
      if (!str) return [];
      return str.split(/[^\d]+/g).map(s=>s.trim()).filter(Boolean);
    }
    function toValidVips(arr){
      const out = new Set();
      for (const raw of arr){
        const n = raw.replace(/^0+/, '').padStart(4,'0');
        if (/^\d{4}$/.test(n) && roomMapVip.has(n)) out.add(n);
      }
      return out;
    }
    function renderChipsVips(filterText=''){
      if (!chipsVips) return;
      chipsVips.innerHTML='';
      const f = (filterText||'').trim();
      let invalid = 0;
      for (const num of Array.from(vipsEdit).sort()){
        const valid = roomMapVip.has(num);
        if (f && !num.includes(f)) continue;
        const chip = document.createElement('span');
        chip.className = 'chip ' + (valid ? 'occ-valid' : 'occ-invalid');
        if (!valid) invalid++;
        chip.innerHTML = `<span>${num}</span><span class="x" title="Quitar" aria-label="Quitar">√ó</span>`;
        chip.querySelector('.x').addEventListener('click', ()=>{
          vipsEdit.delete(num);
          renderChipsVips(filterVips?.value||'');
          if (countVipsInside) countVipsInside.textContent = String(vipsEdit.size);
        });
        chipsVips.appendChild(chip);
      }
      if (countVipsInside) countVipsInside.textContent = String(vipsEdit.size) + (invalid?` (inv√°lidas: ${invalid})`:'');
    }

    function abrirModalVips(){
      vipsEdit = new Set(vipsApplied);
      if (listVips) listVips.value = Array.from(vipsEdit).join(', ');
      renderChipsVips();
      if (vipsBadge) vipsBadge.textContent = `(${vipsApplied.size})`;
      if (modalVips) modalVips.hidden = false;
    }
    function cerrarModalVips(){ if (modalVips) modalVips.hidden = true; }
    mVips?.addEventListener('click', abrirModalVips);
    btnCerrarVips?.addEventListener('click', cerrarModalVips);
    modalVips?.addEventListener('click', (e)=>{ if (e.target===modalVips) cerrarModalVips(); });

    btnPasteVips?.addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if (listVips) listVips.value = t;
        vipsEdit = toValidVips(tokenizeVips(t));
        renderChipsVips(filterVips?.value||'');
      }catch{}
    });
    btnCopyVips?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(Array.from(vipsEdit).join(', ')); }catch{} });
    btnLimpiarVips?.addEventListener('click', ()=>{
      vipsEdit.clear();
      renderChipsVips(filterVips?.value||'');
      if (listVips) listVips.value='';
    });
    filterVips?.addEventListener('input', ()=> renderChipsVips(filterVips.value||''));
    listVips?.addEventListener('input', ()=>{
      vipsEdit = toValidVips(tokenizeVips(listVips.value));
      renderChipsVips(filterVips?.value||'');
    });

    function aplicarVipsEnTabla(){
      // Quitar marca-vip anteriores
      vipsApplied.forEach(num=>{
        const td = roomMapVip.get(num);
        if (td) td.classList.remove('marca-vip');
      });
      vipsApplied.clear();

      // Aplicar nuevos
      vipsEdit.forEach(num=>{
        const td = roomMapVip.get(num);
        if (td){
          td.classList.add('marca-vip');
          vipsApplied.add(num);
        }
      });

      if (vVips)     vVips.textContent = String(vipsApplied.size||0);
      if (vipsBadge) vipsBadge.textContent = `(${vipsApplied.size||0})`;
    }
    btnAplicarVips?.addEventListener('click', aplicarVipsEnTabla);

    if (vVips && !vVips.textContent.trim()) vVips.textContent = '0';

  })();
  </script>

  <script>
  (function(){
    // === RESTAURAR S√ÅBANA ===
    const mReset           = document.getElementById('mReset');
    const modalReset       = document.getElementById('modalReset');
    const inputMatricula   = document.getElementById('resetMatricula');
    const hintMatricula    = document.getElementById('resetMatriculaHint');
    const btnCancelarReset = document.getElementById('btnCancelarReset');
    const btnToggleMatricula = document.getElementById('btnToggleMatricula');
    const btnConfirmarReset= document.getElementById('btnConfirmarReset');
    const resetAlsoEvents  = document.getElementById('resetAlsoEvents');

    const MATRICULA_OK = "3072167";

    function abrirReset(){ if(modalReset) modalReset.hidden = false; setTimeout(()=> inputMatricula?.focus(), 0); }
    function cerrarReset(){ if(modalReset) modalReset.hidden = true; if (inputMatricula) inputMatricula.value=''; if (btnConfirmarReset) btnConfirmarReset.disabled=true; if (hintMatricula){ hintMatricula.textContent='Escribe tu matr√≠cula para habilitar el bot√≥n.'; hintMatricula.style.color=''; } }

    mReset?.addEventListener('click', abrirReset);
    btnCancelarReset?.addEventListener('click', cerrarReset);
    modalReset?.addEventListener('click', (e)=>{ if (e.target===modalReset) cerrarReset(); });

    btnToggleMatricula?.addEventListener('click', ()=>{
      if (!inputMatricula) return;
      inputMatricula.type = (inputMatricula.type === 'password') ? 'text' : 'password';
    });

    inputMatricula?.addEventListener('input', ()=>{
      const ok = (inputMatricula.value.trim() === MATRICULA_OK);
      btnConfirmarReset.disabled = !ok;
      if (hintMatricula) hintMatricula.textContent = ok ? "‚úî Matr√≠cula v√°lida" : "Escribe tu matr√≠cula para habilitar el bot√≥n.";
      if (hintMatricula) hintMatricula.style.color = ok ? "#065f46" : "";
    });

    function resetHeaderCounts(){
      const pairs = [
        ['countSalidas','(0)'],
        ['countLlegadas','(0)'],
        ['countOcupadas','(0)'],
        ['countFuera','(0)'],
        ['countShowroom','(0)'],
      ];
      pairs.forEach(([id,val])=>{ const el = document.getElementById(id); if(el) el.textContent = val; });
    }
    function resetMetricValues(){
      const pairs = [
        ['vExpedia','0'],
        ['vBooking','0'],
        ['vVips','0'],
        ['vQueue','0'],
        ['vIp','0'],
      ];
      pairs.forEach(([id,val])=>{ const el = document.getElementById(id); if(el) el.textContent = val; });
      const vOcup = document.getElementById('vOcup'); if (vOcup){ vOcup.textContent='--%'; }
      const vNps  = document.getElementById('vNps');  if (vNps){ vNps.textContent='--'; }
    }
    function clearAppliedSetsIfExist(){
      const setNames = ['expediaApplied','bookingApplied','vipsApplied','salidasSet','llegadasSet','ocupadasSet','fueraSet','showroomSet','inhouseSet','ipRoomSet'];
      setNames.forEach(n=>{
        try{ if (typeof window[n] !== 'undefined' && window[n] && typeof window[n].clear === 'function') window[n].clear(); }catch{}
      });
    }
    function vaciarTabla(){
      // Quitar clases de estado y marcas en todas las celdas
      const cells = (typeof roomCellMap!=='undefined' && roomCellMap instanceof Map) ? Array.from(roomCellMap.values()) : Array.from(document.querySelectorAll('td'));
      const classes = ['estado-llegada','estado-salida','estado-ocupada','estado-inhouse','estado-iproom','estado-fuera','estado-showroom','marca-expedia','marca-booking','marca-vip'];
      cells.forEach(td => { classes.forEach(c => td.classList.remove(c)); });
      // Reset contadores
      resetHeaderCounts();
      resetMetricValues();
      // Limpiar sets (si existen)
      clearAppliedSetsIfExist();
      // Opcional: borrar eventos
      try{ if (resetAlsoEvents?.checked) localStorage.removeItem('sabana_eventos_v1'); }catch{}
      // Asegurar que el estrobo visual no deje clases raras activas
      document.documentElement.classList.remove('strobeB');
    }

    btnConfirmarReset?.addEventListener('click', ()=>{
      vaciarTabla();
      cerrarReset();
      alert('S√°bana restaurada.');
    });
  })();
  </script>


  <script>
  (function(){
    // === EVENTOS ===
    const EVENTS_KEY = 'sabana_eventos_v1';
    const mEventos   = document.getElementById('mEventos');
    const vEventos   = document.getElementById('vEventos');
    const modalEventos = document.getElementById('modalEventos');
    const eventosBadge = document.getElementById('eventosBadge');

    const evtTitle    = document.getElementById('evtTitle');
    const evtTitleList= document.getElementById('evtTitleList');
    const evtDateTime = document.getElementById('evtDateTime');
    const evtRooms    = document.getElementById('evtRooms');
    const evtTag      = document.getElementById('evtTag');
    const evtSpecs    = document.getElementById('evtSpecs');

    const btnLimpiarEvento = document.getElementById('btnLimpiarEvento');
    const btnCerrarEventos = document.getElementById('btnCerrarEventos');
    const btnGuardarEvento = document.getElementById('btnGuardarEvento');
    const evtFilter        = document.getElementById('evtFilter');
    const eventosLista     = document.getElementById('eventosLista');
    const btnExportEventos = document.getElementById('btnExportEventos');
    const btnImportEventos = document.getElementById('btnImportEventos');

    function loadEvents(){ try{ return JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]'); }catch{ return []; } }
    function saveEvents(arr){ localStorage.setItem(EVENTS_KEY, JSON.stringify(arr)); }
    function uniqTypes(arr){
      const s = new Set();
      arr.forEach(e => { if (e.title) s.add(e.title.trim()); if (e.tag) s.add(e.tag.trim()); });
      return Array.from(s).filter(Boolean).sort();
    }
    function normalizeRooms(s){
      if (!s) return [];
      return s.split(/[^\d]+/g).map(x=>x.trim()).filter(Boolean).map(x=>x.replace(/^0+/, '').padStart(4,'0'));
    }
    function formatDateTimeLocal(dtStr){
      try{
        const d = new Date(dtStr);
        if (isNaN(d)) return dtStr || '';
        return d.toLocaleString(undefined, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      }catch{ return dtStr||''; }
    }
    function updateEventosCounters(){
      const arr = loadEvents();
      const c = arr.length;
      if (vEventos) vEventos.textContent = String(c);
      if (eventosBadge) eventosBadge.textContent = `(${c})`;
      if (evtTitleList){
        const types = uniqTypes(arr);
        evtTitleList.innerHTML = types.map(t=>`<option value="${t}"></option>`).join('');
      }
    }
    function clearEventoForm(){
      if (evtTitle) evtTitle.value = '';
      if (evtDateTime) evtDateTime.value = '';
      if (evtRooms) evtRooms.value = '';
      if (evtTag) evtTag.value = '';
      if (evtSpecs) evtSpecs.value = '';
    }
    function renderEventosList(){
      const arr = loadEvents();
      const q = (evtFilter?.value||'').toLowerCase();
      eventosLista.innerHTML = '';
      arr
        .filter(e => {
          if (!q) return true;
          return (e.title||'').toLowerCase().includes(q) ||
                 (e.tag||'').toLowerCase().includes(q) ||
                 (e.specs||'').toLowerCase().includes(q) ||
                 (e.rooms||[]).join(',').includes(q) ||
                 (e.dt||'').includes(q);
        })
        .sort((a,b)=> (a.dt||'').localeCompare(b.dt||''))
        .forEach(e => {
          const row = document.createElement('div');
          row.className = 'event-row';
          row.innerHTML = `
            <div class="dt">${formatDateTimeLocal(e.dt)}</div>
            <div class="title">${(e.title||'').replace(/</g,'&lt;')}</div>
            <div class="rooms">${(e.rooms||[]).join(', ')}</div>
            <div class="specs">${(e.specs||'').replace(/</g,'&lt;')}</div>
            <div class="actions">
              <button class="btn btn-sm" data-act="load">Cargar</button>
              <button class="btn btn-sm" data-act="del">Eliminar</button>
            </div>`;
          row.querySelector('[data-act="load"]').addEventListener('click', ()=>{
            if (evtTitle) evtTitle.value = e.title||'';
            if (evtDateTime) evtDateTime.value = e.dt||'';
            if (evtRooms) evtRooms.value = (e.rooms||[]).join(', ');
            if (evtTag) evtTag.value = e.tag||'';
            if (evtSpecs) evtSpecs.value = e.specs||'';
          });
          row.querySelector('[data-act="del"]').addEventListener('click', ()=>{
            const now = loadEvents();
            const idx = now.findIndex(x => x.id===e.id);
            if (idx>-1){
              now.splice(idx,1);
              saveEvents(now);
              updateEventosCounters();
              renderEventosList();
            }
          });
          eventosLista.appendChild(row);
        });
    }

    function abrirModalEventos(){
      updateEventosCounters();
      renderEventosList();
      if (modalEventos) modalEventos.hidden = false;
      setTimeout(()=> evtTitle?.focus(), 0);
    }
    function cerrarModalEventos(){ if (modalEventos) modalEventos.hidden = true; }

    mEventos?.addEventListener('click', abrirModalEventos);
    btnCerrarEventos?.addEventListener('click', cerrarModalEventos);
    modalEventos?.addEventListener('click', (e)=>{ if (e.target===modalEventos) cerrarModalEventos(); });
    btnLimpiarEvento?.addEventListener('click', clearEventoForm);
    evtFilter?.addEventListener('input', renderEventosList);

    btnGuardarEvento?.addEventListener('click', ()=>{
      const title = (evtTitle?.value||'').trim();
      const dt    = evtDateTime?.value||'';
      const rooms = normalizeRooms(evtRooms?.value||'');
      const tag   = (evtTag?.value||'').trim();
      const specs = (evtSpecs?.value||'').trim();
      if (!title){ alert('T√≠tulo requerido'); return; }
      const obj = { id: String(Date.now())+'_'+Math.random().toString(36).slice(2,6), title, dt, rooms, tag, specs, createdAt: new Date().toISOString() };
      const arr = loadEvents();
      arr.push(obj);
      saveEvents(arr);
      clearEventoForm();
      updateEventosCounters();
      renderEventosList();
    });

    btnExportEventos?.addEventListener('click', ()=>{
      const blob = new Blob([localStorage.getItem(EVENTS_KEY)||'[]'], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'eventos.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    btnImportEventos?.addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'application/json';
      inp.onchange = () => {
        const f = inp.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(String(reader.result||'[]'));
            if (Array.isArray(data)){
              saveEvents(data);
              updateEventosCounters();
              renderEventosList();
            }else{
              alert('Formato inv√°lido');
            }
          }catch{ alert('No se pudo leer el JSON'); }
        };
        reader.readAsText(f);
      };
      inp.click();
    });

    // Inicializa contador al cargar
    updateEventosCounters();
  })();
  </script>


  <script>
  // Enter = Aplicar en los modales (Shift+Enter mantiene salto de l√≠nea)
  (function(){
    function enterAplica(textareaId, buttonId){
      const ta = document.getElementById(textareaId);
      const btn= document.getElementById(buttonId);
      if(!ta || !btn) return;
      ta.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Enter' && !ev.shiftKey){
          ev.preventDefault();
          btn.click();
        }
      });
    }
    enterAplica('inputSalidas','btnAplicarSalidas');
    enterAplica('inputLlegadas','btnAplicarLlegadas');
    enterAplica('inputOcupadas','btnAplicarOcupadas');
    enterAplica('inputFuera','btnAplicarFuera');
    enterAplica('inputShowroom','btnAplicarShowroom');
    enterAplica('inputIpRoom','btnAplicarIpRoom');
    enterAplica('listExpedia','btnAplicarExpedia');
    enterAplica('listBooking','btnAplicarBooking');
    enterAplica('listVips','btnAplicarVips');
  })();
  </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- === Historial Supabase + Realtime === -->
<script>
(() => {
  const CFG = Object.assign({
    url:  (window.SABANA_SUPABASE && window.SABANA_SUPABASE.url)  || "https://YOUR-PROJECT.supabase.co",
    key:  (window.SABANA_SUPABASE && window.SABANA_SUPABASE.key)  || "YOUR-ANON-KEY",
    table:(window.SABANA_SUPABASE && window.SABANA_SUPABASE.table)|| "sabana_historial",
    uniqueCol: "date_key"
  }, window.SABANA_SUPABASE || {});

  const hasCloud = (typeof CFG.url === "string") &&
                   CFG.url.includes("supabase.co") &&
                   CFG.key && !/YOUR-ANON-KEY/i.test(CFG.key) &&
                   typeof window.supabase !== "undefined";

  const CLIENT_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID()
                     : ("c_" + Math.random().toString(36).slice(2));

  function getDateKey() {
    const el = document.getElementById('fecha');
    let raw = el ? (el.textContent || el.innerText || '').trim() : '';
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
      const [dd, mm, yyyy] = raw.split('/');
      return `${yyyy}-${mm}-${dd}`;
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  const LS_PREFIX = 'sabana:';

  function serializeStateFromDOM() {
    const q = (sel) => Array.from(document.querySelectorAll(sel));
    const takeNums = (nodes) => nodes.map(td => td.textContent.trim()).filter(Boolean);
    return {
      salidas:   takeNums(q('td.estado-salida')),
      llegadas:  takeNums(q('td.estado-llegada')),
      ocupadas:  takeNums(q('td.estado-ocupada')),
      fuera:     takeNums(q('td.estado-fuera')),
      showroom:  takeNums(q('td.estado-showroom')),
      inhouse:   takeNums(q('td.estado-inhouse')),
      iproom:    takeNums(q('td.estado-iproom')),
      booking:   takeNums(q('td.estado-llegada.marca-booking')),
      expedia:   takeNums(q('td.estado-llegada.marca-expedia')),
      vip:       takeNums(q('td.marca-vip')),
      metrics: {
        ocupacion: (document.getElementById('vOcup')   || {}).textContent?.trim() ?? '',
        nps:       (document.getElementById('vNps')    || {}).textContent?.trim() ?? '',
        queue:     (document.getElementById('vQueue')  || {}).textContent?.trim() ?? '',
        ip:        (document.getElementById('vIp')     || {}).textContent?.trim() ?? '',
        vExpedia:  (document.getElementById('vExpedia')|| {}).textContent?.trim() ?? '',
        vBooking:  (document.getElementById('vBooking')|| {}).textContent?.trim() ?? '',
        vVips:     (document.getElementById('vVips')   || {}).textContent?.trim() ?? ''
      },
      _client: CLIENT_ID,
      savedAt: new Date().toISOString()
    };
  }

  function applyStateToDOM(state) {
    if (!state) return;
    // limpiar y aplicar
    const classes = [
      'estado-salida','estado-llegada','estado-ocupada',
      'estado-fuera','estado-showroom','estado-inhouse','estado-iproom',
      'marca-booking','marca-expedia','marca-vip'
    ];
    document.querySelectorAll('table.excel td').forEach(td => classes.forEach(c => td.classList.remove(c)));
    const findRoomTd = (num) => {
      return Array.from(document.querySelectorAll('table.excel td')).find(td => td.childElementCount===0 && td.textContent.trim()===String(num));
    };
    const applyList = (list, cls) => (list||[]).forEach(num => { const td = findRoomTd(num); if (td) td.classList.add(cls); });
    applyList(state.salidas,  'estado-salida');
    applyList(state.llegadas, 'estado-llegada');
    applyList(state.ocupadas, 'estado-ocupada');
    applyList(state.fuera,    'estado-fuera');
    applyList(state.showroom, 'estado-showroom');
    applyList(state.inhouse,  'estado-inhouse');
    applyList(state.iproom,   'estado-iproom');
    applyList(state.booking,  'marca-booking');
    applyList(state.expedia,  'marca-expedia');
    applyList(state.vip,      'marca-vip');

    const setTxt = (id,val)=>{const el=document.getElementById(id);if(el)el.textContent=val;};
    if (state.metrics) {
      setTxt('vOcup',    state.metrics.ocupacion);
      setTxt('vNps',     state.metrics.nps);
      setTxt('vQueue',   state.metrics.queue);
      setTxt('vIp',      state.metrics.ip);
      setTxt('vExpedia', state.metrics.vExpedia);
      setTxt('vBooking', state.metrics.vBooking);
      setTxt('vVips',    state.metrics.vVips);
    }
  }

  function saveLocal(dateKey, state) { try { localStorage.setItem(LS_PREFIX+dateKey, JSON.stringify(state)); } catch {} }
  function loadLocal(dateKey) { try { const raw=localStorage.getItem(LS_PREFIX+dateKey); return raw?JSON.parse(raw):null; } catch { return null; } }

  let sb = null;
  if (hasCloud) sb = window.supabase.createClient(CFG.url, CFG.key);

  async function saveCloud(dateKey, state) {
    if (!sb) return;
    const payload = Object.assign({}, state, { _client: CLIENT_ID });
    await sb.from(CFG.table).upsert({ [CFG.uniqueCol]: dateKey, payload });
  }
  async function loadCloud(dateKey) {
    if (!sb) return null;
    const { data } = await sb.from(CFG.table).select('payload').eq(CFG.uniqueCol,dateKey).maybeSingle();
    return data ? data.payload : null;
  }

  window.guardarDia = async function() {
    const dk=getDateKey(); const st=serializeStateFromDOM();
    saveLocal(dk,st); try{if(sb)await saveCloud(dk,st);}catch(e){}
  };
  window.cargarDia = async function(dateKey) {
    let st=null; try{if(sb)st=await loadCloud(dateKey);}catch(e){}
    if(!st)st=loadLocal(dateKey); if(st)applyStateToDOM(st);
    subscribeRealtime(dateKey);
  };

  let saveTimer=null;
  function scheduleAutosave(){ clearTimeout(saveTimer); saveTimer=setTimeout(async()=>{const dk=getDateKey();const st=serializeStateFromDOM();saveLocal(dk,st);try{if(sb)await saveCloud(dk,st);}catch(e){}},800);}
  const table=document.querySelector('table.excel');
  if(table){ new MutationObserver(scheduleAutosave).observe(table,{attributes:true,childList:true,subtree:true,attributeFilter:['class']});}
  ['vOcup','vNps','vQueue','vIp','vExpedia','vBooking','vVips'].forEach(id=>{const el=document.getElementById(id);if(el)new MutationObserver(scheduleAutosave).observe(el,{characterData:true,childList:true,subtree:true});});

  let channel=null;
  function unsubscribeRealtime(){ if(channel&&sb){ sb.removeChannel(channel); channel=null; } }
  function subscribeRealtime(dateKey){ if(!sb)return; unsubscribeRealtime(); channel=sb.channel('sabana_'+dateKey).on('postgres_changes',{event:'*',schema:'public',table:CFG.table,filter:`${CFG.uniqueCol}=eq.${dateKey}`},(payload)=>{const rec=payload.new||payload.record;if(!rec||!rec.payload)return;if(rec.payload._client===CLIENT_ID)return;applyStateToDOM(rec.payload);saveLocal(dateKey,rec.payload);}).subscribe(); }

  (async function boot(){ const dk=getDateKey(); let st=null; try{if(sb)st=await loadCloud(dk);}catch(e){} if(!st)st=loadLocal(dk); if(st)applyStateToDOM(st); subscribeRealtime(dk); })();
})();
</script>


<div class="cal-backdrop" id="calBackdrop" aria-hidden="true">
  <div class="cal-modal" role="dialog" aria-label="Calendario de Eventos">
    <div class="cal-head">
      <div class="title">
        <span class="cal-close" id="calClose">‚úï</span>
        <span id="calMonthLabel">Calendario</span>
      </div>
      <div class="controls">
        <button class="cal-btn" id="calPrev">‚óÄ</button>
        <button class="cal-btn" id="calToday">Hoy</button>
        <button class="cal-btn" id="calNext">‚ñ∂</button>
        <span class="pill">Total mes: <span id="calMesCount">0</span></span>
      </div>
    </div>
    <div class="cal-body">
      <div class="cal-grid-wrap">
        <div class="cal-grid" id="calGridDOW">
          <div class="cal-dow">Lun</div><div class="cal-dow">Mar</div><div class="cal-dow">Mi√©</div><div class="cal-dow">Jue</div><div class="cal-dow">Vie</div><div class="cal-dow">S√°b</div><div class="cal-dow">Dom</div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div class="cal-aside">
        <h3 id="calAsideTitle">A√±adir evento</h3>
        <div class="muted" id="calAsideSub">Selecciona un d√≠a del calendario</div>
        <div class="cal-field"><label>Habitaci√≥n(es)</label><input id="calRooms" placeholder="1211, 1508 4203"></div>
        <div class="cal-field"><label>T√≠tulo/Tipo</label><input id="calTitle" placeholder="Cumplea√±os / VIP / Corporativo / ..."></div>
        <div class="cal-field"><label>Etiqueta</label><input id="calTag" placeholder="Opcional (luna de miel, etc.)"></div>
        <div class="cal-field"><label>Hora</label><input id="calTime" type="time"></div>
        <div class="cal-field"><label>Notas</label><textarea id="calSpecs" rows="4" placeholder="Especificaciones / montaje / amenidades..."></textarea></div>
        <div class="cal-actions">
          <button class="cal-btn primary" id="calAdd">Agregar</button>
          <button class="cal-btn warn" id="calClearDay">Borrar del d√≠a</button>
        </div>
        <hr>
        <h3>Eventos del d√≠a</h3>
        <div id="calListDia" class="muted">‚Äî</div>
      </div>
    </div>
  </div>
</div>


<script>
(function(){
  const KEY='sabana_eventos_v1';
  const load=()=>{try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return []}};
  const save=a=>localStorage.setItem(KEY,JSON.stringify(a));
  const pad2=n=>String(n).padStart(2,'0');
  const toISO=(y,m,d)=>`${y}-${pad2(m+1)}-${pad2(d)}`;
  const monthName=(y,m)=>new Date(y,m,1).toLocaleDateString(undefined,{month:'long',year:'numeric'});
  const isSame=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
  const $=s=>document.querySelector(s);

  function detectType(title,tag){
    const s=`${title||''} ${tag||''}`.toLowerCase();
    if(/cumple|birthday/.test(s)) return {cls:'cumple',icon:'üéÇ',name:'Cumplea√±os'};
    if(/anivers/.test(s)) return {cls:'aniverso',icon:'üéâ',name:'Aniversario'};
    if(/boda|wedding/.test(s)) return {cls:'boda',icon:'üíç',name:'Boda'};
    if(/honeymoon|luna de miel/.test(s)) return {cls:'honeymoon',icon:'üåô',name:'Luna de miel'};
    if(/shoot|foto|fotogr/.test(s)) return {cls:'shooting',icon:'üì∑',name:'Shooting'};
    if(/vip/.test(s)) return {cls:'vip',icon:'üëë',name:'VIP'};
    if(/corporat|empres|visita/.test(s)) return {cls:'corporativo',icon:'üè¢',name:'Corporativo'};
    if(/amenid|amenity|detalle/.test(s)) return {cls:'amenidad',icon:'üéÅ',name:'Amenidad'};
    return {cls:'especial',icon:'‚òÖ',name:'Evento'};
  }

  let cur=new Date();cur.setDate(1);
  let sel=null;const bd=$('#calBackdrop'),grid=$('#calGrid'),lbl=$('#calMonthLabel'),mesCount=$('#calMesCount'),listDia=$('#calListDia');
  const openBtn=document.getElementById('btnCalendario');

  function openCal(){render();bd.classList.add('show');bd.setAttribute('aria-hidden','false')}
  function closeCal(){bd.classList.remove('show');bd.setAttribute('aria-hidden','true')}

  function render(){
    const y=cur.getFullYear(),m=cur.getMonth();
    lbl.textContent=monthName(y,m).replace(/^\w/,c=>c.toUpperCase());
    grid.innerHTML='';
    const first=new Date(y,m,1), start=(first.getDay()+6)%7, days=new Date(y,m+1,0).getDate();
    const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(y,m,d));

    const events=load(); const byDate={};
    events.forEach(e=>{ if(!e.dt) return; const d=new Date(e.dt); if(isNaN(d)) return; const k=toISO(d.getFullYear(),d.getMonth(),d.getDate()); (byDate[k] ||= []).push(e); });
    let monthTotal=0;

    const today=new Date();

    cells.forEach(dObj=>{
      const cell=document.createElement('div'); cell.className='cal-cell';
      if(!dObj){cell.style.visibility='hidden'; grid.appendChild(cell); return;}
      if(isSame(dObj,today)) cell.classList.add('today');
      const iso=toISO(dObj.getFullYear(),dObj.getMonth(),dObj.getDate());
      const list=byDate[iso]||[]; monthTotal+=list.length;
      const date=document.createElement('div'); date.className='date'; date.textContent=dObj.getDate(); cell.appendChild(date);
      if(list.length){
        const count=document.createElement('div'); count.className='count'; count.textContent=list.length; cell.appendChild(count);
        const chips=document.createElement('div'); chips.className='chips';
        list.slice(0,4).forEach(ev=>{ const meta=detectType(ev.title,ev.tag); const chip=document.createElement('span'); chip.className=`cal-chip ${meta.cls}`; chip.textContent=meta.icon+' '+meta.name; chips.appendChild(chip); });
        if(list.length>4){ const extra=document.createElement('span'); extra.className='cal-chip'; extra.textContent=`+${list.length-4}`; chips.appendChild(extra); }
        cell.appendChild(chips);
      }
      cell.addEventListener('click',()=>{ sel=dObj; updateAside(); });
      grid.appendChild(cell);
    });

    mesCount.textContent=String(monthTotal);
    if(sel && (sel.getMonth()!==cur.getMonth() || sel.getFullYear()!==cur.getFullYear())) sel=null;
    updateAside();
  }

  function updateAside(){
    const asideTitle=$('#calAsideTitle'), asideSub=$('#calAsideSub');
    if(!sel){ asideTitle.textContent='A√±adir evento'; asideSub.textContent='Selecciona un d√≠a del calendario'; listDia.innerHTML='‚Äî'; return; }
    const y=sel.getFullYear(),m=sel.getMonth(),d=sel.getDate();
    asideTitle.textContent=`D√≠a ${d}/${String(m+1).padStart(2,'0')}/${y}`; asideSub.textContent='Ingresa datos y presiona Agregar';
    const events=load().filter(e=>{ const dt=new Date(e.dt); return !isNaN(dt)&&dt.getFullYear()===y&&dt.getMonth()===m&&dt.getDate()===d; });
    if(!events.length){ listDia.innerHTML='‚Äî'; return; }
    listDia.innerHTML='';
    events.forEach(ev=>{ const meta=detectType(ev.title,ev.tag); const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='6px'; row.style.margin='4px 0'; row.innerHTML=`<span>${meta.icon}</span><div style="font:600 12px system-ui;">${ev.title||meta.name} ‚Äî Hab: ${(ev.rooms||[]).join(', ')}</div>`; listDia.appendChild(row); });
  }

  function addFromAside(){
    if(!sel){ alert('Selecciona un d√≠a.'); return; }
    const rooms=($('#calRooms').value||'').replace(/\n/g,' ').split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
    const title=$('#calTitle').value, tag=$('#calTag').value, specs=$('#calSpecs').value, time=$('#calTime').value;
    if(!rooms.length){ alert('Indica al menos una habitaci√≥n.'); return; }
    const iso=toISO(sel.getFullYear(),sel.getMonth(),sel.getDate()); const dt=time?`${iso}T${time}`:iso;
    const arr=load(); arr.push({title,tag,specs,dt,rooms}); save(arr);
    render(); if(typeof window.repaintEventBadgesToday==='function'){ window.repaintEventBadgesToday(); }
  }
  function clearDay(){
    if(!sel) return;
    const y=sel.getFullYear(),m=sel.getMonth(),d=sel.getDate();
    const arr=load().filter(e=>{ const dt=new Date(e.dt); return isNaN(dt)||dt.getFullYear()!==y||dt.getMonth()!==m||dt.getDate()!==d; });
    save(arr); render(); if(typeof window.repaintEventBadgesToday==='function'){ window.repaintEventBadgesToday(); }
  }

  // Wire calendar
  (function(){
    const open=document.getElementById('btnCalendario');
    const close=document.getElementById('calClose');
    const prev=document.getElementById('calPrev');
    const next=document.getElementById('calNext');
    const today=document.getElementById('calToday');
    const add=document.getElementById('calAdd');
    const clear=document.getElementById('calClearDay');
    const backdrop=document.getElementById('calBackdrop');

    if(open) open.addEventListener('click',()=>{ render(); document.getElementById('calBackdrop').classList.add('show'); });
    if(close) close.addEventListener('click',()=>{ document.getElementById('calBackdrop').classList.remove('show'); });
    if(prev) prev.addEventListener('click',()=>{ cur.setMonth(cur.getMonth()-1); render(); });
    if(next) next.addEventListener('click',()=>{ cur.setMonth(cur.getMonth()+1); render(); });
    if(today) today.addEventListener('click',()=>{ cur=new Date(); cur.setDate(1); render(); });
    if(add) add.addEventListener('click', addFromAside);
    if(clear) clear.addEventListener('click', clearDay);
    if(backdrop) backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.classList.remove('show'); });
  })();
})();
</script>


<script>
// === EVENTOS: pintar en celda 3 y enganchar al modal (captura) ===
(function(){
  const KEY = 'sabana_eventos_v1';
  const load = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } };
  const save = arr => localStorage.setItem(KEY, JSON.stringify(arr));
  const pad2=n=>String(n).padStart(2,'0');
  const sameDate=(a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const splitRooms = str => (str||'').replace(/\n/g,' ').split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);

  function parseFecha(val){
    if(!val) return {iso:null,time:''};
    let m = String(val).match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2}))?$/);
    if(m) return {iso:`${m[1]}-${m[2]}-${m[3]}`, time:m[4]?`${m[4]}:${m[5]}`:''};
    m = String(val).match(/^\s*(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})(?:\s+(\d{1,2}):(\d{2})(?:\s*([ap]\.?m\.?))?)?\s*$/i);
    if(m){
      let [_, dd, mm, yyyy, hh, min, ap] = m;
      let H = hh? parseInt(hh,10) : null;
      if(H !== null && ap){ const pm = ap.toLowerCase().startsWith('p'); if(pm && H<12) H+=12; if(!pm && H===12) H=0; }
      return {iso:`${yyyy}-${pad2(mm)}-${pad2(dd)}`, time: H!==null? `${pad2(H)}:${min}` : ''};
    }
    return {iso:null,time:''};
  }
  function detectType(title, tag){
    const s=`${title||''} ${tag||''}`.toLowerCase();
    if(/cumple|birthday/.test(s)) return {icon:'üéÇ',name:'Cumplea√±os'};
    if(/anivers/.test(s))         return {icon:'üéâ',name:'Aniversario'};
    if(/boda|wedding/.test(s))    return {icon:'üíç',name:'Boda'};
    if(/honeymoon|luna de miel/.test(s)) return {icon:'üåô',name:'Luna de miel'};
    if(/shoot|foto|fotogr/.test(s))      return {icon:'üì∑',name:'Shooting'};
    if(/vip/.test(s))             return {icon:'üëë',name:'VIP'};
    if(/corporat|empres|visita/.test(s)) return {icon:'üè¢',name:'Corporativo'};
    if(/amenid|amenity|detalle/.test(s)) return {icon:'üéÅ',name:'Amenidad'};
    return {icon:'‚òÖ',name:'Evento'};
  }
  const iconFrom = e => detectType(e.title, e.tag).icon;

  function buildSlotMap(){
    const map = new Map();
    document.querySelectorAll('table.excel tr').forEach(tr=>{
      const tds = Array.from(tr.children);
      for(let i=0;i<tds.length;i+=3){
        const tdNum = tds[i], tdSlot = tds[i+2];
        if(!tdNum || !tdSlot) continue;
        const room = (tdNum.textContent||'').trim();
        if(!/^\d{3,5}$/.test(room)) continue;
        tdSlot.style.position='relative';
        map.set(room, tdSlot);
      }
    });
    return map;
  }
  function clearAll(slotMap){
    slotMap.forEach(slot=>{
      slot.querySelectorAll('.evt-badge,.evt-pop').forEach(n=>n.remove());
      const t = (slot.textContent||'').trim();
      if(t==='') slot.textContent='-';
    });
  }
  function formatDT(s){
    try{const d=new Date(s); if(isNaN(d)) return String(s||''); return d.toLocaleString(undefined,{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{return String(s||'')}
  }
  function closePops(){ document.querySelectorAll('.evt-pop').forEach(n=>n.remove()); }

  function repaint(){
    const slots = buildSlotMap();
    clearAll(slots);
    const today = new Date();
    const todays = load().filter(e=>{ if(!e||!e.dt) return false; const d=new Date(e.dt); return !isNaN(d) && sameDate(d,today); });
    todays.forEach(e=>{
      (e.rooms||[]).forEach(r=>{
        const slot = slots.get(String(r)); if(!slot) return;
        slot.textContent='';
        const badge = document.createElement('span');
        badge.className='evt-badge';
        badge.textContent = iconFrom(e);
        badge.title = `${e.title || e.tag || 'Evento'} ‚Äî ${formatDT(e.dt)} ‚Äî Hab ${r}`;
        badge.addEventListener('click', ev=>{
          ev.stopPropagation(); closePops();
          const pop = document.createElement('div');
          pop.className='evt-pop';
          pop.innerHTML = `<div class="close" title="cerrar">√ó</div>
            <h4>${e.title || e.tag || 'Evento'} ‚Äî Hab. ${r}</h4>
            <div class="row">üìÖ ${formatDT(e.dt)}</div>
            ${e.specs ? `<div class="nota">${e.specs}</div>` : ''}`;
          pop.addEventListener('click', ev=>ev.stopPropagation());
          slot.appendChild(pop);
          pop.querySelector('.close').addEventListener('click', ev=>{ ev.stopPropagation(); closePops(); });
        });
        slot.appendChild(badge);
      });
    });
    const c = todays.length;
    const v = document.getElementById('vEventos'); if(v) v.textContent=String(c);
    const b = document.getElementById('eventosBadge'); if(b) b.textContent=`(${c})`;
  }
  window.repaintEventBadgesToday = repaint;

  // Hook modal "Agregar" (captura) para guardar y repintar sin depender de IDs fijos
  document.addEventListener('click', (ev)=>{
    const t = ev.target;
    if(!t || t.tagName!=='BUTTON') return;
    const txt = (t.textContent||'').trim().toLowerCase();
    if(txt!=='agregar') return;
    // buscar modal por t√≠tulo "Gestionar Eventos"
    const modals = Array.from(document.querySelectorAll('.modal,[role="dialog"],.modal-eventos'));
    const modal = modals.find(m => /gestionar\s+eventos/i.test(m.textContent||'')) || document;
    const $ = sel => modal.querySelector(sel);

    const inTitle = $('input[placeholder*="Cumple"]') || $('#evtTitle') || $('#evtType');
    const inFecha = $('input[type="datetime-local"]') || $('input[placeholder^="dd/"]') || $('#evtDate');
    const inHora  = $('input[type="time"]') || $('#evtTime');
    const inRooms = $('input[placeholder*="coma/espacio"]') || $('input[placeholder*="Habitaci√≥n"]') || $('#evtRoom');
    const inTag   = $('input[placeholder*="Etiqueta"]') || $('input[placeholder*="luna de miel"]') || $('#evtTag');
    const inNotas = modal.querySelector('textarea') || $('#evtNotas');

    const rooms = splitRooms(inRooms && inRooms.value);
    const fechaRaw = (inFecha && inFecha.value) || '';
    const horaRaw  = (inHora && inHora.value) || '';
    const title = inTitle && inTitle.value;
    const tag   = inTag && inTag.value;
    const specs = inNotas && inNotas.value;

    const full = (fechaRaw.includes('T') || /\\d{2}:\\d{2}/.test(fechaRaw)) ? fechaRaw : `${fechaRaw} ${horaRaw}`;
    const {iso,time} = parseFecha(full);
    if(!rooms.length || !iso) return;
    const dt = time? `${iso}T${time}` : iso;

    const arr = load(); arr.push({ title, tag, specs, dt, rooms }); save(arr);
    setTimeout(repaint, 60);
  }, true);

  document.addEventListener('click', ()=>{ closePops(); });
  document.addEventListener('DOMContentLoaded', repaint);
  if(document.readyState==='complete' || document.readyState==='interactive'){ repaint(); }
})();
</script>


<div class="hist-backdrop" id="histBackdrop" aria-hidden="true">
  <div class="hist-modal" role="dialog" aria-label="Hist√≥rico de S√°bana">
    <div class="hist-head">
      <div class="title"><span class="hist-close" id="histClose">‚úï</span> <span>Hist√≥rico de S√°bana</span></div>
      <div class="hist-controls">
        <div class="field">Fecha: <input type="date" id="histDate"></div>
        <div class="field">Guardados: 
          <select id="histList"><option value="">‚Äî</option></select>
        </div>
        <button class="btn primary" id="histOpen">Abrir</button>
        <button class="btn" id="histExport">Exportar</button>
        <label class="btn" for="histImportFile">Importar</label><input id="histImportFile" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <div class="hist-body">
      <div class="hist-view" id="histView"><div class="snapshot muted" style="padding:20px;color:#64748b;font:600 14px system-ui">Elige una fecha y pulsa ‚ÄúAbrir‚Äù.</div></div>
    </div>
  </div>
</div>


<script>
(function(){
  const SNAP_KEY = 'sabana_snapshots_v1';
  const LAST_KEY = 'sabana_last_seen_date';

  const $ = s => document.querySelector(s);
  const pad2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };

  function loadSnaps(){
    try{ return JSON.parse(localStorage.getItem(SNAP_KEY)||'{}'); }catch{ return {}; }
  }
  function saveSnaps(obj){
    localStorage.setItem(SNAP_KEY, JSON.stringify(obj));
  }

  function captureSabanaHTML(){
    const tbl = document.querySelector('table.excel');
    if(!tbl) return '';
    return tbl.outerHTML;
  }

  function saveSnapshot(dateISO, reason='manual'){
    if(!dateISO) return;
    const snaps = loadSnaps();
    // Don't overwrite unless reason === 'manual' (but we will overwrite anyway to keep latest)
    snaps[dateISO] = {
      html: captureSabanaHTML(),
      events: (function(){ try{ return JSON.parse(localStorage.getItem('sabana_eventos_v1')||'[]'); }catch{ return []; } })(),
      saved_at: new Date().toISOString(),
      reason
    };
    saveSnaps(snaps);
    populateHistList();
  }

  function openSnapshot(dateISO){
    const snaps = loadSnaps();
    const snap = snaps[dateISO];
    const view = $('#histView');
    if(!snap){ view.innerHTML = `<div class="snapshot" style="padding:20px;font:600 14px system-ui;color:#991b1b">No hay snapshot para ${dateISO}</div>`; return; }
    view.innerHTML = `<div class="snapshot">${snap.html}</div>`;
  }

  function populateHistList(){
    const sel = $('#histList'); if(!sel) return;
    const snaps = loadSnaps();
    const dates = Object.keys(snaps).sort().reverse();
    sel.innerHTML = `<option value="">‚Äî</option>` + dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  }

  function ensureAutoArchive(){
    const last = localStorage.getItem(LAST_KEY);
    const today = todayISO();
    if(last && last !== today){
      // The day changed since last time ‚Üí archive snapshot of previous day if not present
      const snaps = loadSnaps();
      if(!snaps[last]){
        saveSnapshot(last, 'auto');
      }
      // Optionally clear visual badges (the repaint already handles showing only today's)
      if(typeof window.repaintEventBadgesToday === 'function') setTimeout(window.repaintEventBadgesToday, 50);
    }
    localStorage.setItem(LAST_KEY, today);
  }

  // UI wiring
  function wireHistoricoUI(){
    const btn = document.getElementById('btnHistorico');
    const bd = document.getElementById('histBackdrop');
    const close = document.getElementById('histClose');
    const open = document.getElementById('histOpen');
    const date = document.getElementById('histDate');
    const list = document.getElementById('histList');
    const exp = document.getElementById('histExport');
    const imp = document.getElementById('histImportFile');

    if(btn){ btn.addEventListener('click', ()=>{ populateHistList(); bd.classList.add('show'); }); }
    if(close){ close.addEventListener('click', ()=> bd.classList.remove('show')); }
    if(bd){ bd.addEventListener('click', (e)=>{ if(e.target===bd) bd.classList.remove('show'); }); }
    if(open){
      open.addEventListener('click', ()=>{
        const d = date.value || list.value;
        if(!d){ alert('Elige una fecha.'); return; }
        openSnapshot(d);
      });
    }
    if(list){
      list.addEventListener('change', ()=>{
        if(list.value) openSnapshot(list.value);
      });
    }
    if(exp){
      exp.addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(loadSnaps(), null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'sabana_snapshots.json';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      });
    }
    if(imp){
      imp.addEventListener('change', ()=>{
        const f = imp.files && imp.files[0]; if(!f) return;
        const rd = new FileReader();
        rd.onload = () => {
          try{
            const obj = JSON.parse(rd.result);
            const cur = loadSnaps();
            saveSnaps(Object.assign(cur, obj));
            populateHistList();
            alert('Snapshots importados.');
          }catch(e){ alert('Archivo inv√°lido.'); }
        };
        rd.readAsText(f);
      });
    }
  }

  // Auto-archive checker every 60s (in case la pesta√±a queda abierta)
  setInterval(ensureAutoArchive, 60000);

  document.addEventListener('DOMContentLoaded', ()=>{
    ensureAutoArchive();
    wireHistoricoUI();
  });
  if(document.readyState==='complete' || document.readyState==='interactive'){
    ensureAutoArchive();
    wireHistoricoUI();
  }
})();
</script>


<script>
/**
 * Sincronizaci√≥n en tiempo real con Supabase para la tabla public.events
 * - Carga el mes actual al abrir/abrir calendario
 * - Suscribe a INSERT/UPDATE/DELETE (WebSocket)
 * - Captura eventos agregados localmente (localStorage 'sabana_eventos_v1' sin id)
 *   y los sube a Supabase autom√°ticamente (les pone id) para que todos los devices los vean.
 */
(function(){
  const KEY_EVENTS = 'sabana_eventos_v1';
  const hasCfg = !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY && window.SUPABASE_URL.includes('supabase.co'));
  const sb = (window.supabase && hasCfg) ? window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY) : null;
  window.__sb = sb; // debug

  const pad2=n=>String(n).padStart(2,'0');
  function monthBounds(d){
    const from = new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0);
    const to   = new Date(d.getFullYear(), d.getMonth()+1, 1, 0,0,0);
    return {from, to};
  }
  function repaint(){
    if(typeof window.repaintEventBadgesToday==='function'){ window.repaintEventBadgesToday(); }
  }
  function loadLocal(){
    try{ return JSON.parse(localStorage.getItem(KEY_EVENTS)||'[]'); }catch{ return []; }
  }
  function saveLocal(arr){
    localStorage.setItem(KEY_EVENTS, JSON.stringify(arr||[]));
  }

  // === Merge remoto ‚Üí local, por id ===
  function mergeRemoteIntoLocal(rows, {preserveOutside=true}={}){
    const local = loadLocal();
    const map = new Map(local.map(e=>[e.id||`${e.dt}|${(e.rooms||[]).join(',')}|${e.title||''}|${e.tag||''}|${e.specs||''}`, e]));
    rows.forEach(r=>{
      const k = r.id || `${r.dt}|${(r.rooms||[]).join(',')}|${r.title||''}|${r.tag||''}|${r.specs||''}`;
      map.set(k, { id:r.id, dt:r.dt, title:r.title, tag:r.tag, specs:r.specs, rooms:r.rooms||[], created_by:r.created_by });
    });
    const merged = Array.from(map.values());
    saveLocal(merged);
    repaint();
  }

  async function fetchMonth(d=new Date()){
    if(!sb) return;
    const {from, to} = monthBounds(d);
    try{
      const { data, error } = await sb.from('events')
        .select('*')
        .gte('dt', from.toISOString())
        .lt('dt', to.toISOString())
        .order('dt', { ascending:true });
      if(error){ console.warn('Supabase fetch error', error); return; }
      mergeRemoteIntoLocal(data);
    }catch(e){ console.error(e); }
  }

  // === Subir locales (sin id) ‚Üí Supabase y asignar id ===
  let pushing = false;
  async function pushNewLocalToSupabase(){
    if(!sb || pushing) return;
    const arr = loadLocal();
    const pending = arr.filter(e => !e.id && e.dt && (e.rooms||[]).length);
    if(!pending.length) return;
    pushing = true;
    try{
      for(const e of pending){
        const payload = {
          dt: e.dt,
          title: e.title || null,
          tag: e.tag || null,
          specs: e.specs || null,
          rooms: e.rooms || [],
          created_by: (function(){ try{ return JSON.parse(localStorage.getItem('sabana_session_v1')||'null')?.id || null; }catch{return null;} })()
        };
        const { data, error } = await sb.from('events').insert(payload).select().single();
        if(!error && data){
          // asignar id en local y guardar
          const cur = loadLocal();
          const idx = cur.findIndex(x => x===e || (!x.id && x.dt===e.dt && (x.title||'')===(e.title||'') && (x.tag||'')===(e.tag||'') && (x.specs||'')===(e.specs||'') && JSON.stringify(x.rooms||[])===JSON.stringify(e.rooms||[])));
          if(idx>=0){ cur[idx] = Object.assign({}, e, { id: data.id }); saveLocal(cur); }
        }else if(error){ console.warn('Supabase insert error', error); }
      }
    }catch(err){ console.error(err); }
    finally{ pushing = false; }
  }

  // === Realtime ===
  function subscribeRealtime(){
    if(!sb) return;
    try{
      const ch = sb.channel('events_rt')
        .on('postgres_changes', { event:'*', schema:'public', table:'events' }, payload => {
          if(payload.eventType === 'INSERT' || payload.eventType==='UPDATE'){
            const r = payload.new;
            mergeRemoteIntoLocal([r]);
          }else if(payload.eventType === 'DELETE'){
            const id = payload.old?.id;
            if(id){
              const cur = loadLocal().filter(x=>x.id!==id);
              saveLocal(cur); repaint();
            }
          }
        })
        .subscribe();
      window.__sbEventsCh = ch;
    }catch(e){ console.warn('SB subscribe error', e); }
  }

  // === Detectar cambios locales y subir (cuando alguien agregue desde el modal existente) ===
  let lastJSON = null;
  setInterval(()=>{
    const curJSON = localStorage.getItem(KEY_EVENTS) || '[]';
    if(curJSON !== lastJSON){
      lastJSON = curJSON;
      pushNewLocalToSupabase();
    }
  }, 1200);

  // === Refrescar al abrir Calendario si existe bot√≥n ===
  const btnCal = document.getElementById('btnCalendario');
  if(btnCal){ btnCal.addEventListener('click', ()=> fetchMonth(new Date())); }

  // === Init ===
  if(sb){
    fetchMonth(new Date());
    subscribeRealtime();
  } else {
    console.warn('Supabase NO configurado ‚Äî operando solo con localStorage.');
  }
})();
</script>

</body>
</html>

<script>
(function(){
  // Helpers
  const sb = window.__sb;
  const KEY_EVENTS = 'sabana_eventos_v1';
  const pad2 = n => String(n).padStart(2,'0');
  function monthBounds(d){ return { from: new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0), to: new Date(d.getFullYear(), d.getMonth()+1, 1, 0,0,0) }; }
  function repaint(){ if(typeof window.repaintEventBadgesToday==='function'){ window.repaintEventBadgesToday(); } }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(KEY_EVENTS)||'[]'); }catch{return []} }
  function saveLocal(a){ localStorage.setItem(KEY_EVENTS, JSON.stringify(a||[])); }
  function setSBStatus(txt, ok){
    const el = document.getElementById('sbStatus'); if(!el) return;
    el.style.display = 'inline-block';
    el.textContent = 'SB: ' + txt;
    el.style.background = ok ? '#ecfdf5' : '#fef2f2';
    el.style.color = ok ? '#065f46' : '#7f1d1d';
    el.style.borderColor = ok ? '#10b981' : '#fecaca';
  }
  function parseCalMonthLabel(){
    const el = document.getElementById('calMonthLabel'); if(!el) return null;
    const t = (el.textContent||'').trim().toLowerCase();
    const map = {'enero':0,'febrero':1,'marzo':2,'abril':3,'mayo':4,'junio':5,'julio':6,'agosto':7,'septiembre':8,'setiembre':8,'octubre':9,'noviembre':10,'diciembre':11};
    const m = t.match(/([a-z√°√©√≠√≥√∫√±]+)\s+(\d{4})/i);
    if(!m) return null;
    const mm = map[m[1].normalize('NFD').replace(/[\u0300-\u036f]/g,'')]; const yy = parseInt(m[2],10);
    return (mm!=null) ? new Date(yy, mm, 1) : null;
  }
  async function fetchMonth(d){
    if(!sb || !window.sbRefreshMonth){ return; }
    try{ await window.sbRefreshMonth(d||new Date()); setSBStatus('online', true); }
    catch{ setSBStatus('error', false); }
  }

  // A) Hook prev/next/today to fetch month shown
  ['calPrev','calNext','calToday'].forEach(id=>{
    const b=document.getElementById(id);
    if(b){
      b.addEventListener('click', ()=>{
        setTimeout(()=>{ const d = parseCalMonthLabel() || new Date(); fetchMonth(d); }, 120);
      });
    }
  });

  // B) Normalize dt before local save is pushed (midday local if no time)
  function normalizeDt(dt){
    if(!dt) return dt;
    if(/T\d{2}:\d{2}/.test(dt)) return dt; // already has time
    const p = dt.split('-'); if(p.length<3) return dt;
    const d = new Date(Number(p[0]), Number(p[1])-1, Number(p[2]), 12, 0, 0);
    return d.toISOString();
  }
  // Wrap local setter (wherever events get saved) by watching storage mutations and normalizing
  const _setItem = localStorage.setItem.bind(localStorage);
  localStorage.setItem = function(k,v){
    if(k===KEY_EVENTS && typeof v==='string'){
      try{
        const arr = JSON.parse(v||'[]');
        let changed=false;
        arr.forEach(e=>{ if(e && e.dt && !/T\d{2}:\d{2}/.test(e.dt)){ e.dt = normalizeDt(e.dt); changed=true; } });
        if(changed) v = JSON.stringify(arr);
      }catch{}
    }
    return _setItem(k,v);
  };

  // C) Direct insert on "Agregar" (modal/calendario) para no depender del polling
  async function insertToSB(payload){
    if(!sb) return false;
    try{
      const { data, error } = await sb.from('events').insert(payload).select().single();
      if(error){ console.warn('SB insert error', error); setSBStatus('error', false); return false; }
      setSBStatus('online', true);
      // Merge immediate in local (realtime tambi√©n llegar√°)
      const arr = loadLocal(); arr.push({ ...payload, id:data.id }); saveLocal(arr); repaint();
      return true;
    }catch(e){ console.error(e); setSBStatus('error', false); return false; }
  }
  function extractFromModalOrCalendar(isCal){
    const pad2=n=>String(n).padStart(2,'0');
    const scope = isCal ? document : (Array.from(document.querySelectorAll('.modal,[role="dialog"],.modal-eventos')).find(m => /gestionar\s+eventos/i.test(m.textContent||'')) || document);
    const q = s => scope.querySelector(s);
    const inTitle = isCal ? document.getElementById('calTitle') : (q('input[placeholder*="Cumple"]') || q('#evtTitle') || q('#evtType'));
    const inFecha = isCal ? { value: (function(){ const sel = window.__calSelDate; if(sel){ return `${sel.getFullYear()}-${pad2(sel.getMonth()+1)}-${pad2(sel.getDate())}` } return ''; })() } : (q('input[type="datetime-local"]') || q('input[placeholder^="dd/"]') || q('#evtDate'));
    const inHora  = isCal ? document.getElementById('calTime') : (q('input[type="time"]') || q('#evtTime'));
    const inRooms = isCal ? document.getElementById('calRooms') : (q('input[placeholder*="coma/espacio"]') || q('input[placeholder*="Habitaci√≥n"]') || q('#evtRoom'));
    const inTag   = isCal ? document.getElementById('calTag') : (q('input[placeholder*="Etiqueta"]') || q('input[placeholder*="luna de miel"]') || q('#evtTag'));
    const inNotas = isCal ? document.getElementById('calSpecs') : (scope.querySelector('textarea') || q('#evtNotas'));
    function parseFecha(val,hora){
      if(!val) return null;
      if(/^\d{4}-\d{2}-\d{2}/.test(val)) return hora && /\d\d:\d\d/.test(hora) ? `${val}T${hora}` : val;
      const m = String(val||'').match(/^\s*(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})/);
      if(m){ return `${m[3]}-${pad2(m[2])}-${pad2(m[1])}${hora && /\d\d:\d\d/.test(hora) ? `T${hora}`:''}`; }
      return null;
    }
    const rooms = (inRooms?.value||'').replace(/\n/g,' ').split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
    const dtRaw = parseFecha(inFecha?.value, inHora?.value);
    const dt = normalizeDt(dtRaw);
    const title = inTitle?.value||''; const tag = inTag?.value||''; const specs = inNotas?.value||'';
    return { rooms, dt, title, tag, specs };
  }
  document.addEventListener('click', async (ev)=>{
    const t = ev.target;
    if(!t || t.tagName!=='BUTTON') return;
    const txt = (t.textContent||'').trim().toLowerCase();
    const isCal = t.id==='calAdd';
    if(txt==='agregar' || isCal){
      if(!sb){ setSBStatus('sin sb', false); return; }
      const e = extractFromModalOrCalendar(isCal);
      if(e.rooms.length && e.dt){
        // inserta directo a SB; el local se actualizar√° por realtime y por merge inmediato
        await insertToSB({ dt:e.dt, rooms:e.rooms, title:e.title||null, tag:e.tag||null, specs:e.specs||null, created_by: null });
      }
    }
  }, true);

  // D) Refresh de seguridad cada 10s del mes mostrado
  setInterval(()=>{
    if(!sb) return;
    const d = parseCalMonthLabel() || new Date();
    fetchMonth(d);
  }, 10000);

  // E) Mostrar estado inicial
  setSBStatus(sb ? 'conectando‚Ä¶' : 'sin sb', !!sb);

  // Si el canal realtime ya exist√≠a, mu√©stralo como online
  setTimeout(()=> setSBStatus('online', !!sb), 1200);
})();
</script>

<script>
(function(){
  const sb = window.__sb;
  const status = document.getElementById('sbStatus');
  function setSBStatus(txt, tone){
    if(!status) return;
    const tones = {
      ok:  {bg:'#ecfdf5', bd:'#10b981', fg:'#065f46'},
      warn:{bg:'#fef3c7', bd:'#f59e0b', fg:'#7c2d12'},
      err: {bg:'#fee2e2', bd:'#fecaca', fg:'#7f1d1d'}
    };
    const t = tones[tone||'warn'];
    status.textContent = 'SB: ' + txt;
    status.style.background = t.bg; status.style.borderColor = t.bd; status.style.color = t.fg;
  }
  function parseCalMonthLabel(){
    const el = document.getElementById('calMonthLabel'); if(!el) return null;
    const t = (el.textContent||'').trim().toLowerCase();
    const map = {'enero':0,'febrero':1,'marzo':2,'abril':3,'mayo':4,'junio':5,'julio':6,'agosto':7,'septiembre':8,'setiembre':8,'octubre':9,'noviembre':10,'diciembre':11};
    const m = t.match(/([a-z√°√©√≠√≥√∫√±]+)\s+(\d{4})/i);
    if(!m) return null;
    const mm = map[m[1].normalize('NFD').replace(/[\u0300-\u036f]/g,'')]; const yy = parseInt(m[2],10);
    return (mm!=null) ? new Date(yy, mm, 1) : null;
  }
  async function refreshMonthNow(){
    const d = parseCalMonthLabel() || new Date();
    if (window.sbRefreshMonth){
      try{ await window.sbRefreshMonth(d); setSBStatus('online', 'ok'); }
      catch(e){ setSBStatus('error', 'err'); }
    } else {
      setSBStatus('sin-modulo', 'err');
    }
  }

  // Wire force button
  const forceBtn = document.getElementById('btnSBForce');
  if(forceBtn){ forceBtn.addEventListener('click', refreshMonthNow); }

  // On visibility back or network online ‚Üí refresh
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') refreshMonthNow(); });
  window.addEventListener('online', refreshMonthNow);

  // Realtime status probing (simple): if __sbEventsCh exists, assume ok
  setTimeout(()=>{
    if(sb && window.__sbEventsCh){ setSBStatus('online', 'ok'); }
    else if(sb){ setSBStatus('conectando‚Ä¶', 'warn'); refreshMonthNow(); }
    else { setSBStatus('sin sb', 'err'); }
  }, 800);
})();
</script>
