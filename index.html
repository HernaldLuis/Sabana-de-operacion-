<!-- Supabase SDK + Live Sync TOTAL (pegar antes de </body>) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  #sbBubble{position:fixed;right:12px;bottom:12px;z-index:9999;background:#0b1220;color:#d1e9ff;
  padding:8px 10px;border-radius:10px;font:600 12px system-ui;box-shadow:0 6px 16px rgba(2,6,23,.35);opacity:.9;display:none}
</style>
<div id="sbBubble">SBâ€¦</div>
<script>
(function(){
  "use strict";
  // ðŸ‘‰ TUS CREDENCIALES
  const SB_URL = "https://mzjthivwubvvjjsvbhtb.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16anRoaXZ3dWJ2dmpqc3ZiaHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjA3MzAsImV4cCI6MjA3MjUzNjczMH0.1wNvnBjhnOLLtpD-JmH1Hytrbo4P6HI6rA5Yv7mWaEs";

  const bubble = document.getElementById('sbBubble');
  const badge  = document.getElementById('sbStatus'); // si existe en tu header
  function status(txt, ok=true){
    if(bubble){ bubble.style.display='block'; bubble.textContent = 'SB: '+txt; }
    if(badge){  badge.style.display='inline-block';
                badge.textContent='SB: '+txt;
                badge.style.background = ok?'#dcfce7':'#fee2e2';
                badge.style.borderColor = ok?'#10b981':'#ef4444';
                badge.style.color = ok?'#065f46':'#7f1d1d'; }
  }

  if(!window.supabase){ status('sin-modulo', false); return; }
  const sb = supabase.createClient(SB_URL, SB_KEY);
  const clientId = (localStorage.getItem("sb_client_id") || (Date.now()+"-"+Math.random().toString(16).slice(2)));
  localStorage.setItem("sb_client_id", clientId);

  function todayKey(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
  const DATE = todayKey();
  function getTable(){ return document.querySelector('table.excel'); }

  // Carga inicial desde el servidor
  async function loadInitial(){
    try{
      const { data, error } = await sb.from('sabana_state_live')
        .select('html, updated_at').eq('date_key', DATE).maybeSingle();
      if(error) throw error;
      if(data && data.html){ applyHtml(data.html); }
      status('online');
    }catch(e){ console.warn(e); status('offline', false); }
  }

  // Reemplaza la tabla por la versiÃ³n recibida
  function applyHtml(html){
    const tbl=getTable(); if(!tbl||!html) return;
    const tmp=document.createElement('div'); tmp.innerHTML=html.trim();
    const newNode = tmp.firstElementChild; if(!newNode) return;
    tbl.replaceWith(newNode);
    status('actualizado (remoto)');
  }

  // Captura y guarda (debounced) cuando editas/click dentro de la tabla
  let lastHtml=null, saving=false, t=null;
  function captureHtml(){ const tbl=getTable(); return tbl?tbl.outerHTML:null; }
  async function saveNow(){
    const html=captureHtml(); if(!html || html===lastHtml) return;
    saving=true;
    try{
      const payload={ date_key: DATE, html, updated_by: clientId };
      const { error } = await sb.from('sabana_state_live').upsert(payload,{ onConflict:'date_key' });
      if(error) throw error;
      lastHtml=html; status('guardado âœ“');
    }catch(e){ console.error(e); status('error al guardar', false); }
    finally{ saving=false; }
  }
  function scheduleSave(){ if(saving) return; clearTimeout(t); t=setTimeout(saveNow, 700); }

  // Escucha interacciones dentro de la tabla
  ['click','input','change','keydown'].forEach(evt=>{
    document.body.addEventListener(evt, (e)=>{
      const tbl=getTable(); if(tbl && tbl.contains(e.target)) scheduleSave();
    }, true);
  });

  // Realtime: escucha cambios de otros clientes
  try{
    sb.channel('sabana_live')
      .on('postgres_changes',
          { event:'*', schema:'public', table:'sabana_state_live', filter:'date_key=eq.'+DATE },
          (payload)=>{ if(payload.new && payload.new.html) applyHtml(payload.new.html); })
      .subscribe();
  }catch(e){ console.warn('realtime',e); }

  // Ping rÃ¡pido para marcar "online"
  (async ()=>{
    try{
      const { error } = await sb.from('sabana_state_live').select('date_key',{head:true,count:'exact'});
      if(error) throw error;
      status('online');
    }catch(e){ status('offline', false); }
  })();

  loadInitial();
})();
</script>
<!-- /Supabase SDK + Live Sync TOTAL -->
